<!doctype html>




<html class="theme-next pisces" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Note down something">
<meta property="og:url" content="http://www.pirrla.cn/index.html">
<meta property="og:site_name" content="Note down something">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Note down something">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":true},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.pirrla.cn/"/>





  <title> Note down something </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Note down something</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/22/jenkins/jenkins7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/22/jenkins/jenkins7/" itemprop="url">
                  Jenkins学习笔记6-搭建gitlabs仓库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-22T00:00:00+08:00">
                2017-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于需要实现代码仓库的质量管理操作，所以我们需要搭建一个gitlab的仓库。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/22/jenkins/jenkins6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/22/jenkins/jenkins6/" itemprop="url">
                  Jenkins学习笔记6-搭建gitlabs仓库&DockerWeb管理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-22T00:00:00+08:00">
                2017-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins-git/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins,git</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-搭建gitlab仓库"><a href="#1-搭建gitlab仓库" class="headerlink" title="1. 搭建gitlab仓库"></a>1. 搭建gitlab仓库</h3><p>由于需要实现代码仓库的质量管理操作，所以我们需要搭建一个gitlab的仓库。</p>
<blockquote>
<p>GitLab是一个利用 <code>Ruby on Rails</code> 开发的开源应用程序，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。 </p>
<p>　　GitLab拥有与Github类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。</p>
</blockquote>
<p>现在有了docker，所以搭建运行环境都比较方便，我们这里直接使用docker进行gitlab的搭建。</p>
<p>使用以下命令拉取所需要的docker镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker pull sameersbn/redis</div><div class="line">docker pull sameersbn/postgresql</div><div class="line">docker pull sameersbn/gitlab</div></pre></td></tr></table></figure>
<h3 id="2-Docker-WebGUI管理"><a href="#2-Docker-WebGUI管理" class="headerlink" title="2. Docker WebGUI管理"></a>2. Docker WebGUI管理</h3><ol>
<li><p><a href="https://github.com/shipyard/shipyard" target="_blank" rel="external">shipyard</a>国产，但是20天前刚刚宣布停止更新</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins22.png" alt=""></p>
</li>
<li><p><a href="http://rancher.com/" target="_blank" rel="external">rancher</a> 硬性条件：需要一台linux服务器做主机，至少2G内存和20G硬盘，较少更新</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins23.png" alt=""></p>
</li>
<li><p><a href="https://github.com/kevana/ui-for-docker" target="_blank" rel="external">kevana</a>已停止更新</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins24.png" alt=""></p>
</li>
<li><p><a href="https://portainer.io/" target="_blank" rel="external">portainer</a>比较轻量，github显示更新及时</p>
</li>
</ol>
<p>此处选择了portainer。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins19.png" alt=""></p>
<p>References:</p>
<p>[1] <a href="http://blog.csdn.net/abcdocker/article/category/6638595" target="_blank" rel="external">持续集成 by www.abcdocker.com</a></p>
<p>[2] <a href="https://www.jianshu.com/p/060e7223e211?open_source=weibo_search" target="_blank" rel="external">https://www.jianshu.com/p/060e7223e211?open_source=weibo_search</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/22/jenkins/jenkins5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/22/jenkins/jenkins5/" itemprop="url">
                  Jenkins学习笔记5-官方用法pipeline
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-22T00:00:00+08:00">
                2017-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>官方的文档是在描述另一种jenkins的用法pipeline。pipeline有其特有的语句，我们以下以一个node.js和npm的例子来进行说明。</p>
<p>Reference:</p>
<p>[1] <a href="http://www.jianshu.com/p/b524b151d35f" target="_blank" rel="external">Jenkins使用简易教程</a></p>
<p>[2] <a href="https://testerhome.com/topics/10003" target="_blank" rel="external">https://testerhome.com/topics/10003</a></p>
<p>[3] <a href="https://personal-notes.me/%E5%9F%BA%E4%BA%8E-jenkinsdocker-%E6%90%AD%E5%BB%BA%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E6%96%B9%E6%A1%88/" target="_blank" rel="external">https://personal-notes.me/%E5%9F%BA%E4%BA%8E-jenkinsdocker-%E6%90%AD%E5%BB%BA%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E6%96%B9%E6%A1%88/</a></p>
<p>[4] <a href="https://yq.aliyun.com/articles/80459" target="_blank" rel="external">https://yq.aliyun.com/articles/80459</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/21/jenkins/jenkins4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/21/jenkins/jenkins4/" itemprop="url">
                  Jenkins学习笔记4-使用Docker对环境和代码打包
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-21T00:00:00+08:00">
                2017-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当我们已经完成了了尝试重启Node.js服务之后，我们应该发现，远程的代码仓库对于node.js的代码，是没有保存Node Modules的。这个文件夹包含的都是node.js需要的第三方的环境库等的包，所以不适合放入远程仓库里。</p>
<p>于是我们每次都需要执行一次<code>npm install</code>的操作，确保下载全部的包。但是这样的操作十分耗时耗力，所以我们考虑到使用docker对我们的基础环境进行打包，生成dockerfile和dockerimage，从而就不需要每次都对生产环境进行更新操作。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins11.png" alt=""></p>
<h3 id="1-docker简介"><a href="#1-docker简介" class="headerlink" title="1. docker简介"></a>1. docker简介</h3><p>安装docker就不介绍了，可以直接从<a href="https://www.docker.com" target="_blank" rel="external">官网</a>按照指引安装</p>
<h5 id="1-1-docker的一些基础概念"><a href="#1-1-docker的一些基础概念" class="headerlink" title="1.1 docker的一些基础概念"></a>1.1 docker的一些基础概念</h5><ul>
<li><strong>镜像（image）</strong>：相当于docker容器启动的母版，docker启动的都是从镜像延伸出来的容器，可以自己构建和存储在镜像仓库</li>
<li><strong>容器（container）</strong>：由单一服务构成的针对最基本功能实现的 <strong>服务（service）</strong>（比如Nginx），docker推荐的是一个容器一个服务</li>
</ul>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins18.png" alt=""></p>
<h5 id="1-2-docker基础操作"><a href="#1-2-docker基础操作" class="headerlink" title="1.2 docker基础操作"></a>1.2 docker基础操作</h5><p>docker的具体操作可以查看<a href="https://docs.docker.com/" target="_blank" rel="external">官方文档</a>或者命令行<code>docker —help</code>，这里介绍一些比较常用的</p>
<p><strong>容器生命周期管理</strong></p>
<ul>
<li><p><code>docker run -p 80:80 -v /data:/data -d nginx:latest</code></p>
<p>创建一个新的容器并运行一个命令，通常使用是<code>-p 80:80</code> 将宿主机的80端口与docker容器的80端口绑定，<code>-v /data:/data</code>将宿主机的文件路径与docker容器内部的文件相映射，通常用来存储容器的数据，从而达到增量更新和缓存的目的，<code>-d</code>是后台运行并返回新创建容器的id，<code>nginx:latest</code>是镜像名和标签</p>
</li>
<li><p><code>docker start</code> 启动一个或多少已经被停止的容器</p>
<p><code>docker stop</code> 停止一个运行中的容器</p>
<p><code>docker restart</code>重启容器</p>
</li>
<li><p><code>docker rm</code>移除一个容器，当容器停止之后不会消失，需要手动删除</p>
</li>
</ul>
<p><strong>容器操作</strong></p>
<ul>
<li><code>docker ps</code>查看当前正在运行的容器，<code>-a</code>可以查看所有容器包括未运行的</li>
</ul>
<p><strong>本地镜像管理</strong></p>
<ul>
<li><code>docker build -t 创建的镜像名称和标签 文件路径</code>使用文件路径的Dockerfile创建镜像，如果镜像名称和标签有重复的，则最新的镜像会使用该名称和标签，旧的镜像将变成\<none\>，在后述操作当中可以批量删除。</none\></li>
<li><code>docker rmi</code>移除镜像</li>
</ul>
<p><strong>镜像仓库</strong></p>
<ul>
<li><code>docker push</code></li>
<li><code>docker pull</code></li>
</ul>
<h5 id="1-3-dockerfile构建"><a href="#1-3-dockerfile构建" class="headerlink" title="1.3 dockerfile构建"></a>1.3 dockerfile构建</h5><p>docker可以直接使用官方的镜像，包含基础运行程序的环境，但如果希望创建新的镜像，可以使用dockerfile进行构建。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设定镜像的官方运行环境</span></div><div class="line"><span class="keyword">FROM</span> google/nodejs</div><div class="line"><span class="comment"># 设定docker内部工作环境为根目录下的app文件夹</span></div><div class="line"><span class="keyword">WORKDIR</span> /app</div><div class="line"><span class="comment"># 添加宿主机中的package.json文件进入docker内app文件夹</span></div><div class="line"><span class="keyword">ADD</span> package.json /app/</div><div class="line"><span class="comment"># 在docker内部运行npm install命令，根据需要安装第三方库</span></div><div class="line"><span class="keyword">RUN</span> npm install</div><div class="line"><span class="comment"># 添加宿主机当前目录的所有文件进入docker</span></div><div class="line"><span class="keyword">ADD</span> . /app</div><div class="line"><span class="comment"># 暴露docker的8000端口</span></div><div class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></div><div class="line"><span class="comment"># 不运行命令</span></div><div class="line"><span class="keyword">CMD</span> []</div><div class="line"><span class="comment"># 启动服务</span></div><div class="line"><span class="keyword">ENTRYPOINT</span> ["/nodejs/bin/npm", "start"]</div></pre></td></tr></table></figure>
<h5 id="1-4-docker-compose-与jenkins类似"><a href="#1-4-docker-compose-与jenkins类似" class="headerlink" title="1.4 docker compose 与jenkins类似"></a>1.4 docker compose 与jenkins类似</h5><h5 id="1-5-docker-私有仓库搭建"><a href="#1-5-docker-私有仓库搭建" class="headerlink" title="1.5 docker 私有仓库搭建"></a>1.5 docker 私有仓库搭建</h5><p>仓库的搭建也不难，只用使用官方的registry docker即可。</p>
<p>启动代码<code>sudo docker run -d -p 5000:5000 -v /data:/tmp/registry —restart=always --name</code></p>
<p>即在5000端口启动了一个仓库docker</p>
<font color="red">*</font>一般启动registryd docker会遇到https安全传输的问题。<br><br>一般当尝试向服务器push镜像时，会出现错误<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Forbidden. If this private registry supports only HTTP or HTTPS with an unknown CA certificate, please add –insecure-registry 10.0.0.26:5000 to the daemon’s arguments.</div></pre></td></tr></table></figure><br><br>解决这个问题的方法见<a href="http://stackoverflow.com/questions/26710153/remote-access-to-a-private-docker-registry" target="_blank" rel="external">StackOverflow</a><br>最快最简单的方法是将如下行添加到<code>/etc/default/docker</code>，然后重启Docker Daemon：<br><code>DOCKER_OPTS=&quot;--insecure-registry localhost:5000&quot;</code><br><br>##### 1.6 Swarm集群拓展<br><br>##### 1.7 小问题：<br><br>- 当docker启动后，希望添加docker与宿主机的端口映射<br><br>  docker容器的操作变换很方便快捷，同时消耗比较少，所以如果希望更改端口映射，不建议手工添加，最好还是重新开启一个容器，使用docker官方的用法<code>-p 5000:5000</code><br><br>  如果容器内有工作内容需要保存，可以commit一个docker image保存数据，然后再启动一个新的容器<br><br><br>- docker容器启动的后的进入方法<br><br>  docker还是提倡一个容器一个进程的理念，但是有时还是需要进入docker容器中，进行一些配置，所以我们需要一个方法进入已经启动的docker容器内，同时需要一个终端进行交互<br><br>  - docker attach<br>  - docker 第三方工具(nsenter、nsinit)<br>  - docker exec<font color="“red”">（推荐）</font>

<h5 id="1-8-Docker镜像仓库国内加速"><a href="#1-8-Docker镜像仓库国内加速" class="headerlink" title="1.8 Docker镜像仓库国内加速"></a>1.8 Docker镜像仓库国内加速</h5><p><a href="http://www.cnblogs.com/anliven/p/6218741.html" target="_blank" rel="external">http://www.cnblogs.com/anliven/p/6218741.html</a></p>
<h3 id="2-APACHE服务器"><a href="#2-APACHE服务器" class="headerlink" title="2.APACHE服务器"></a><del>2.APACHE服务器</del></h3><h3 id="3-Jenkins持续化集成"><a href="#3-Jenkins持续化集成" class="headerlink" title="3.Jenkins持续化集成"></a>3.Jenkins持续化集成</h3><p>介绍完docker和apache，我们希望能够通过jenkins进行一个集成，能够自动化实现在docker容器中的apache服务器的重启操作。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins16.png" alt=""></p>
<h5 id="3-1-在jenkins中使用docker有两种方法"><a href="#3-1-在jenkins中使用docker有两种方法" class="headerlink" title="3.1 在jenkins中使用docker有两种方法"></a>3.1 在jenkins中使用docker有两种方法</h5><ol>
<li>为jenkins添加用户权限，直接在命令行执行</li>
<li>使用docker build step plugin 插件进行docker操作</li>
</ol>
<p>因为插件操作比较麻烦，所以我们选择给jenkins添加用户权限，从而直接在命令行中编写脚本</p>
<p><font color="red">*</font>为macos添加jenkins用户权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 使用id查看自己的群组和用户名称</div><div class="line">$ id</div><div class="line">uid=501(alan) gid=20(staff)  ...</div><div class="line"></div><div class="line"># 获取之后，先停止jenkins服务</div><div class="line">$ sudo launchctl unload /Library/LaunchDaemons/org.jenkins-ci.plist</div></pre></td></tr></table></figure>
<p>然后通过命令行或者直接修改<code>/Library/LaunchDaemons/org.jenkins-ci.plist</code>文件</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins20.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 然后添加权限</div><div class="line">$ sudo chown -R userName /Users/Shared/Jenkins</div><div class="line">$ sudo chown -R userName /var/log/jenkins</div><div class="line"></div><div class="line">#重启Jenkins</div><div class="line">$ sudo launchctl load /Library/LaunchDaemons/org.jenkins-ci.plist</div></pre></td></tr></table></figure>
<h5 id="3-2-编写jenkins设置"><a href="#3-2-编写jenkins设置" class="headerlink" title="3.2 编写jenkins设置"></a>3.2 编写jenkins设置</h5><p>之前的设置跟<a href="http://pirrla.cn/2017/12/18/jenkins/jenkins1/" target="_blank" rel="external">第一篇</a>设置一样，设定好每分钟自动从代码库获取更新</p>
<p>然后到了构建操作脚本</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins17.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">id</div><div class="line">set +e</div><div class="line">echo &apos;&gt;&gt;&gt; Get old container id&apos;</div><div class="line"></div><div class="line"># 查找正在运行的docker容器</div><div class="line">CID=$(/usr/local/bin/docker ps | grep &quot;my_nodejs&quot; | awk &apos;&#123;print $1&#125;&apos;)</div><div class="line"># 获取使用“my_nodejs”镜像的容器id</div><div class="line">echo $CID</div><div class="line"></div><div class="line"># 根据新的代码，构建新的docker</div><div class="line">/usr/local/bin/docker build -t my_nodejs .</div><div class="line"></div><div class="line"># 停止旧的容器</div><div class="line">if [ &quot;$CID&quot; != &quot;&quot; ];then</div><div class="line">  /usr/local/bin/docker stop $CID</div><div class="line">fi</div><div class="line"></div><div class="line"># 启动新容器</div><div class="line">/usr/local/bin/docker run -p 8000:8000 -d my_nodejs</div><div class="line"></div><div class="line"># 删除旧容器</div><div class="line">/usr/local/bin/docker rm $CID</div><div class="line"># 删除旧镜像</div></pre></td></tr></table></figure>
<p>这样就完成了一个自动化部署docker的操作。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins15.png" alt=""></p>
<p>References:</p>
<p>[1] <a href="http://www.cnblogs.com/Leo_wl/p/4314792.html" target="_blank" rel="external">使用Jenkins来构建Docker容器</a></p>
<p>[2] <a href="http://www.runoob.com/docker/docker-tutorial.html" target="_blank" rel="external">Docker 教程</a></p>
<p>[3] <a href="http://blog.huangang.net/2017/01/06/docker%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%90%8E%E6%B7%BB%E5%8A%A0%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/" target="_blank" rel="external">Docker启动后的端口映射</a></p>
<p>[4] <a href="http://blog.csdn.net/woshiluahuo/article/details/52239407" target="_blank" rel="external">进入docker容器的方法</a></p>
<p>[5] <a href="http://blog.csdn.net/u010397369/article/details/41045251" target="_blank" rel="external">如何进入Docker容器</a></p>
<p>[6] <a href="https://blog.catscarlet.com/201612022593.html" target="_blank" rel="external">https://blog.catscarlet.com/201612022593.html</a></p>
<p>[7] <a href="http://ju.outofmemory.cn/entry/306621" target="_blank" rel="external">http://ju.outofmemory.cn/entry/306621</a></p>
<p>[8] <a href="https://www.qcloud.com/community/article/164816001481011806" target="_blank" rel="external">https://www.qcloud.com/community/article/164816001481011806</a></p>
<p>[9] <a href="https://www.jianshu.com/p/41f2def6ec59" target="_blank" rel="external">https://www.jianshu.com/p/41f2def6ec59</a></p>
<p>[10] <a href="http://www.cnblogs.com/ihojin/p/jenkins-permission.html" target="_blank" rel="external">Mac Jenkins 权限问题</a></p>
<p>[11] <a href="https://blog.catscarlet.com/201612022593.html" target="_blank" rel="external">https://blog.catscarlet.com/201612022593.html</a></p>
<p>[12] <a href="http://www.runoob.com/docker/docker-command-manual.html" target="_blank" rel="external">Docker 命令大全</a></p>
<p>[13] <a href="http://blog.51cto.com/tangoo/1435078" target="_blank" rel="external">Mac Jenkins 修改端口</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/20/jenkins/jenkins3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/20/jenkins/jenkins3/" itemprop="url">
                  Jenkins学习笔记3-重启Node.js服务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-20T00:00:00+08:00">
                2017-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们在之前的文章已经完成了当github上python代码有新的push操作之后，jenkins会自动pull最新的代码，并进行编译执行。因为python代码不能体现服务的持续展现，所以我们现在选择一个网页网站的node.js页面进行尝试。</p>
<h3 id="1-项目代码简介"><a href="#1-项目代码简介" class="headerlink" title="1.项目代码简介"></a>1.项目代码简介</h3><p>简单的网页面显示，没有具体的数据存储操作</p>
<h3 id="2-代码Jenkins部署"><a href="#2-代码Jenkins部署" class="headerlink" title="2.代码Jenkins部署"></a>2.代码Jenkins部署</h3><h5 id="2-1-安装node-js插件"><a href="#2-1-安装node-js插件" class="headerlink" title="2.1 安装node.js插件"></a>2.1 安装node.js插件</h5><p>到jenkins插件管理界面下载<a href="https://wiki.jenkins.io/display/JENKINS/NodeJS+Plugin" target="_blank" rel="external">Node.js插件</a></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins12.png" alt=""></p>
<p>安装完，对jenkins进行重启</p>
<h5 id="2-2-插件配置"><a href="#2-2-插件配置" class="headerlink" title="2.2 插件配置"></a>2.2 插件配置</h5><p>进入<strong>Jenkins - Manage Jenkins - Global Tool Configuration</strong>设置页面</p>
<p>找到NodeJS设置，点击<strong>NodeJS installations…</strong></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins13.png" alt=""></p>
<p>帮这个node.js环境填上一个名字，然后选择需要安装的版本号。</p>
<p>保存，即可。</p>
<h5 id="2-3-NPM-install"><a href="#2-3-NPM-install" class="headerlink" title="2.3 NPM install"></a>2.3 NPM install</h5><p>现在选择Build Now，不管有没有job，系统会先安装node.js环境在workspace里。</p>
<p>然后去到job的配置页面，在build里加入<strong>Execute NodeJS script</strong>操作</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins14.png" alt=""></p>
<font color="red">这里如果把语句放入Node.js脚本执行框，会提示错误。（很奇怪，待研究）</font>

<p>所以我们将语句按顺序，放在script下面的shell脚本里，node.js脚本为空。</p>
<p>执行<code>npm install</code>对从远程仓库下载下来的代码进行构建，安装第三方库。</p>
<h5 id="2-4-PM2守护进程"><a href="#2-4-PM2守护进程" class="headerlink" title="2.4 PM2守护进程"></a>2.4 PM2守护进程</h5><ul>
<li><p>尝试一</p>
<p>直接在shell脚本中执行<code>node index.js</code>操作，node.js服务正常启动，可以正常访问网页，但是在jenkins中，该job是一直处于执行的阶段，如果有新的代码推送上代码仓库，虽然jenkins可以获取到新的代码，但是因为旧的job一直执行，造成阻塞，只能人工进行停止服务，不能实现代码构建部署自动化</p>
</li>
<li><p>尝试二</p>
<p>因为直接启动node.js不行，所以我们考虑使用nohup进行后台执行，使用脚本<code>nohup node index.js &amp;</code>，虽然显示无错误，该job也正常执行完成，但是无法访问网站，查看进程发现不存在node.js进程</p>
</li>
<li><p>尝试三</p>
<p>因为nohup不能持久地运行node.js服务，所以我们选了一个进程守护程序来守护进程，我们选择的是<a href="https://github.com/Unitech/pm2" target="_blank" rel="external">pm2</a>，先在shell脚本中加入代码<code>npm install pm2 -g</code>，然后再启动进程<code>pm2 start index.js</code>，经过测试node.js进程成功常驻后台，网页访问正常，jenkins正常完成job的构建。</p>
<p>由于我们希望达到自动化代码构建部署的效果，所以jenkins的shell脚本更改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pm2 stop index.js</div><div class="line">pm2 start index.js</div></pre></td></tr></table></figure>
<p>这样当代码有更新的时候，先对原先的node.js进行停止，然后重新开启新的node.js服务。</p>
</li>
</ul>
<p>至此，完成node.js代码的自动化构建部署。</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><p>对于网页项目，还有许多的流程持续发布，都需要经过浏览器测试的环节。</p>
<h5 id="1-可以部署多个浏览器环境进行测试："><a href="#1-可以部署多个浏览器环境进行测试：" class="headerlink" title="1.可以部署多个浏览器环境进行测试："></a>1.可以部署多个浏览器环境进行测试：</h5><p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins11.png" alt=""></p>
<p>在网站的上线之前，可以部署一些浏览器测试环境，例如Firefox,IE,Safari等等的不同环境，当全部环境通过测试之后，才发布，提高了产品的容错性。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/19/jenkins/jenkins2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/19/jenkins/jenkins2/" itemprop="url">
                  Jenkins学习笔记2-代码质量管理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-19T00:00:00+08:00">
                2017-12-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-代码质量管理"><a href="#1-代码质量管理" class="headerlink" title="1.代码质量管理"></a>1.代码质量管理</h3><p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins1.png" alt=""></p>
<p>此次代码质量管理的需求，是在用户将本地的代码提交到远程仓库前，进行代码质量分析。</p>
<p>此处的代码质量不单单指有无拼写错误、格式错误等，还包括代码重复率、鲁棒性、注释率等等的指标。所以单纯的syntax错误已经不能满足我们的需求，我们希望团队能够写出高效的代码。</p>
<h3 id="2-SonarQube"><a href="#2-SonarQube" class="headerlink" title="2.SonarQube"></a>2.SonarQube</h3><p>Sonar是一个用于代码质量管理的开放平台，同样支持很多的插件，可以集成不同的测试工具，从而对多种语言(包括Java、C/C++，Javascript，C#等)的代码进行分析，并且以数据可视化的界面进行显示，提高了代码的审查率。</p>
<h5 id="2-1-SonarQube安装"><a href="#2-1-SonarQube安装" class="headerlink" title="2.1 SonarQube安装"></a>2.1 SonarQube安装</h5><p>可以到<a href="https://www.sonarqube.org/downloads/" target="_blank" rel="external">官网</a>下载最新的LTS包，Windows平台的话可以直接执行wrapper.exe文件，即可启动Sonar服务，unix平台的可以通过<code>./sonar.sh start</code>启动服务。</p>
<p><code>./sonar.sh stop</code>停止服务</p>
<p><code>./sonar.sh restart</code>重启服务</p>
<p>当出现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Starting SonarQube...</div><div class="line">Started SonarQube.</div></pre></td></tr></table></figure>
<p>则启动成功</p>
<p>默认的端口是9000，访问<code>localhost:9000</code>需要进行登录。</p>
<p>默认的用户名和密码都是<code>admin</code></p>
<h5 id="2-2-SonarQube-Scanner安装"><a href="#2-2-SonarQube-Scanner安装" class="headerlink" title="2.2 SonarQube Scanner安装"></a>2.2 SonarQube Scanner安装</h5><p>除了SonarQube服务外，我们还需要安装一个SonarQube Scanner作为分析源码的软件。</p>
<p><a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner" target="_blank" rel="external">下载地址</a>下载相应系统版本的scanner之后，进行解压缩，放置到适当的位置。</p>
<p>最好能将该文件夹的bin文件夹添加入环境变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#Macos下添加环境变量的方法</div><div class="line">#在命令行输入</div><div class="line">$ vi ~/.bash_profile</div><div class="line"></div><div class="line">#在文件的最后添加类似的路径</div><div class="line">export PATH=/usr/local/sonar-scanner-3.0.3.778-macosx/bin:$PATH</div><div class="line">#即完成了添加</div></pre></td></tr></table></figure>
<p>然后可以进入对配置文件<code>./conf/sonar-scanner.properties</code>进行设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#基础设置两个就可以了</div><div class="line">#----- Default SonarQube server 设置SonarQube的服务地址</div><div class="line">sonar.host.url=http://localhost:9000</div><div class="line"></div><div class="line">#----- Default source code encoding 设置默认的源码编码格式</div><div class="line">sonar.sourceEncoding=UTF-8</div></pre></td></tr></table></figure>
<p>然后当我们需要对一个项目进行代码分析时，需要在项目的根目录上创建一个<code>sonar*-project.properties</code>文件，对项目信息进行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 为这个项目配置唯一的标识码（必填）</div><div class="line"># 例如以下的URL的id就是标识码</div><div class="line"># http://localhost:9000/dashboard?id=myproject</div><div class="line">sonar.projectKey=myproject</div><div class="line"># 这是在SonarQube上展示的名字和版本号(重要选填)</div><div class="line">sonar.projectName=My project</div><div class="line">sonar.projectVersion=1.0</div><div class="line"></div><div class="line"># 源码的地址(必填)，有多个路径用&apos;,&apos;符号隔开</div><div class="line"># 不同系统需要注意路径的&apos;/&apos;和&apos;\&apos;符号</div><div class="line">sonar.sources=.</div><div class="line"> </div><div class="line"># 编码，默认是系统编码(选填)</div><div class="line">#sonar.sourceEncoding=UTF-8</div></pre></td></tr></table></figure>
<p>然后直接命令行运行<code>sonar-scanner</code>即可，我们现在可以在SonarQube上看到代码质量分析报告了。</p>
<p>如果不是在当前目录运行代码分析，可以设定字段<code>sonar.projectBaseDir=</code>来制定代码的位置。</p>
<p>当然如果不希望重新为每一个项目创造一个配置文件，或者无法再根目录创建文件，还有两种替代性的方法可以配置：</p>
<ul>
<li>可以在命令行启动sonar-scanner的时候添加上配置，例如</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># -D&lt;arg&gt;定义配置</div><div class="line">sonar-scanner -Dsonar.projectKey=myproject -Dsonar.sources=src1</div></pre></td></tr></table></figure>
<ul>
<li>可以在另外的位置创建配置文件，然后启动sonar-scanner的时候设置路径</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sonar-scanner -Dproject.settings=../myproject.properties</div></pre></td></tr></table></figure>
<h5 id="2-3-MySQL配置"><a href="#2-3-MySQL配置" class="headerlink" title="2.3 MySQL配置"></a>2.3 MySQL配置</h5><p>sonar内部是有配置数据库的，但是效率低不能应用于生产环境，所以我们需要配置自己的数据库，用户保存sonar的分析报告和配置等。</p>
<p>这里选择的是MySQL的分支MariaDB，因为MySQL有两种引擎，MyISAM和InnoDB，而MyISAM是比较老旧的引擎了，所以sonar不支持MyISAM，所以我们选择使用MariaDB。</p>
<p>配置文件在<code>sonarqube-6.7/conf/sonar.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sonar.jdbc.username=sonar            #数据库用户</div><div class="line">sonar.jdbc.password=sonar@pw     #数据库密码</div><div class="line"></div><div class="line">sonar.jdbc.url=jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;character    Encoding=utf8&amp;rewriteBatchedStatements=true&amp;useConfigs=maxPerformance</div></pre></td></tr></table></figure>
<p>只需要把数据库的用户名和密码填上，然后解除SQL的注释就可以了。</p>
<p>可能还需要将数据库驱动放入<code>sonarqube-6.7/extensions/jdbc-driver/mysql</code>中</p>
<h5 id="2-3-SonarQube-简介"><a href="#2-3-SonarQube-简介" class="headerlink" title="2.3 SonarQube 简介"></a>2.3 SonarQube 简介</h5><h3 id="3-FindBugs"><a href="#3-FindBugs" class="headerlink" title="3.FindBugs"></a>3.FindBugs</h3><h3 id="4-PMD"><a href="#4-PMD" class="headerlink" title="4.PMD"></a>4.PMD</h3><p>参考资料：</p>
<p>[1] <a href="https://docs.sonarqube.org/display/PLUG/GitHub+Plugin" target="_blank" rel="external">Github Plugin for Sonar</a></p>
<p>[2] <a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner" target="_blank" rel="external">SonarQube Scanner</a></p>
<p>[3] <a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+Jenkins" target="_blank" rel="external">Analyzing with SonarQube Scanner for Jenkins</a></p>
<p>[4] <a href="https://docs.sonarqube.org/display/SONAR/Analysis+Parameters" target="_blank" rel="external">Analysis Parameters</a></p>
<p>[5] <a href="https://stackoverflow.com/questions/32047585/jenkins-sonar-github-integration" target="_blank" rel="external">https://stackoverflow.com/questions/32047585/jenkins-sonar-github-integration</a></p>
<p>[6] <a href="https://github.com/10up/wp-local-docker/issues/6" target="_blank" rel="external">Docker启动SonarQube错误es137</a></p>
<p>[7] <a href="https://yq.aliyun.com/articles/316487" target="_blank" rel="external">https://yq.aliyun.com/articles/316487</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/18/jenkins/jenkins1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/18/jenkins/jenkins1/" itemprop="url">
                  Jenkins学习笔记1-Jenkins入门&Python代码初试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-18T00:00:00+08:00">
                2017-12-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-敏捷开发"><a href="#1-敏捷开发" class="headerlink" title="1.敏捷开发"></a>1.敏捷开发</h3><p>普通的程序开发，是按照瀑布流一样的流程往下走的。</p>
<p>但是时至今日，客户的需求变化速度非常之快，而且生产环境也在不断变化，所以以往的单一的以计划来完成软件开发已经不可取了。</p>
<p>所以我们需要采取敏捷开发，<em>*</em></p>
<h5 id="1-1-什么是持续集成："><a href="#1-1-什么是持续集成：" class="headerlink" title="1.1 什么是持续集成："></a>1.1 什么是持续集成：</h5><p>持续集成是指开发者在代码的开发过程中，可以频繁的将代码部署集成到主干，并进程自动化测试<br><img src="http://static.zybuluo.com/abcdocker/141k7ufqcy5zmgjvzlsgx444/image_1b4gk79111oqbf1l16qd80kqqh8q.png" alt="image_1b4gk79111oqbf1l16qd80kqqh8q.png-73.4kB"></p>
<h5 id="1-2-什么是持续交付："><a href="#1-2-什么是持续交付：" class="headerlink" title="1.2 什么是持续交付："></a>1.2 什么是持续交付：</h5><p>持续交付指的是在持续集成的环境基础之上，将代码部署到预生产环境<br><img src="http://static.zybuluo.com/abcdocker/z47rzhss99x3gxahr93ovn45/image_1b4gk7hef1v4n6ino701pruj9n97.png" alt="image_1b4gk7hef1v4n6ino701pruj9n97.png-133.6kB"></p>
<h5 id="1-3-持续部署："><a href="#1-3-持续部署：" class="headerlink" title="1.3 持续部署："></a>1.3 持续部署：</h5><p>在持续交付的基础上，把部署到生产环境的过程自动化，持续部署和持续交付的区别就是最终部署到生产环境是自动化的。<br><img src="http://static.zybuluo.com/abcdocker/4i4r6iwdisn4zmsmhqewxoew/image_1b4gk7o2t162hb71vcg1bb5p989k.png" alt="image_1b4gk7o2t162hb71vcg1bb5p989k.png-132.2kB"></p>
<h3 id="2-Jenkins入门"><a href="#2-Jenkins入门" class="headerlink" title="2.Jenkins入门"></a>2.Jenkins入门</h3><h5 id="2-1-Jenkins安装"><a href="#2-1-Jenkins安装" class="headerlink" title="2.1 Jenkins安装"></a>2.1 Jenkins安装</h5><p>Jenkins是Java编写的，所以需要安装JDK。可以去<a href="https://www.oracle.com/java/index.html" target="_blank" rel="external">Oracle官网</a>进行下载</p>
<p>在<a href="https://jenkins.io/" target="_blank" rel="external">Jenkins官网</a>下载.war文件，然后直接在命令行运行<code>java -jar jenkins.war</code>，如果需要后天启动可以<code>nohup java -jar jenkins.war &amp;</code></p>
<p>当命令行出现<code>INFO: Jenkins is fully up and running</code>即已经成功启动了服务。</p>
<p>默认端口为8080，可以在启动命令后加上 <code>—httpPort=8081</code>更改默认的启动端口。</p>
<p>启动设置还有：</p>
<p><code>—httpsPort=$HTTP_PORT</code>表示使用 https 协议。<br><code>—httpListenAddress=$HTTP_HOST</code>用来指定 jenkins 监听的 ip 范围，默认为所有的 ip 都可以访问此 jenkins server。</p>
<p>当然也可以把.war包部署进tomcat的webapps里面。</p>
<h5 id="2-2-Jenkins启动"><a href="#2-2-Jenkins启动" class="headerlink" title="2.2 Jenkins启动"></a>2.2 Jenkins启动</h5><p>启动了Jenkins服务之后，我们登录<code>localhost:8080</code>提示需要输入安全token。</p>
<p>根据提示，安全token在安装完jenkins会在本地的文件夹当中，例如macos会存放在<code>/Users/Shard/Jenkins/home/secrets/initialAdminPassword</code></p>
<p>输入完密码之后，会提示安装建议安装的插件。</p>
<p><img src="http://static.zybuluo.com/abcdocker/2dtjyesj3ae5zmyhxmer2kl2/image_1b4gkgcvk1c641d3k1e761jn6h10ae.png" alt=""></p>
<p>然后会提示创建一个管理员账户</p>
<p><img src="http://static.zybuluo.com/abcdocker/wkz0tuy8b3855c1q3s64vd7x/image_1b4gkkuopf351o7fltt17on13jbl.png" alt=""></p>
<p>创建完成则正式进入jenkins。</p>
<p><img src="http://static.zybuluo.com/abcdocker/tcz7eoamylmpjl1dekyzt6d0/image_1b4gkl8sf1o1m12b9h9q1p85hsc2.png" alt=""></p>
<p>**</p>
<p>macos如果遇到没有权限进入的文件夹，右键get info 然后添加权限用户即可</p>
<p>例如配置jenkins需要进入的<code>/Users/Shard/Jenkins/home/secrets</code></p>
<p>**</p>
<h5 id="2-3-Jenkins的简介"><a href="#2-3-Jenkins的简介" class="headerlink" title="2.3 Jenkins的简介"></a>2.3 Jenkins的简介</h5><p>Jenkins的关闭、重启等操作，可以通过查找进程，获取pid号，然后kill进程来完成。</p>
<p>但是更便捷的方法是，在jenkins的url中执行一些命令来操作jenkins，</p>
<p>如下<a href="http://[jenkins-server]/[command" target="_blank" rel="external">http://[jenkins-server]/[command</a>] 命令可以为：</p>
<ul>
<li><code>exit</code> 关闭 jenkins</li>
<li><code>restart</code> 重启 jenkins</li>
<li><code>reload</code> 重新载入配置 configuration</li>
</ul>
<p>Jenkins的目录（例如macos在<code>/Users/Shared/Jenkins</code>）中的<code>Jenkins/Home/jobs</code>是jenkins的核心内容，包含了jenkins的项目的配置、构建日志等重要信息，对jenkins进行备份，主要备份该文件夹即可。</p>
<p>Jenkins其实是一个开源的平台，主要的功能实现都是依靠插件完成，所以平台的设置没有太多，比较重要的是插件设置，所以我们将对使用到的具体的插件设置在后面讲述。</p>
<h3 id="3-简易Python脚本启动"><a href="#3-简易Python脚本启动" class="headerlink" title="3.简易Python脚本启动"></a>3.简易Python脚本启动</h3><p>首先我们点击左上角的<strong>New Item</strong>，新建一个job</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins2.png" alt=""></p>
<p>我们需要对这个job命名，因为是一个简单的实验项目，所以我们选择的是<strong>Freestyle project</strong></p>
<p>其中的<strong>Pipeline</strong>其实是官方推荐的持续部署的写法，但是有其特殊的编写语法，所以我们会在后面再去使用</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins3.png" alt=""></p>
<p>然后我们进入了一个freestyle job的设置页面。</p>
<ul>
<li><p><strong>Discard old builds</strong></p>
<p> 一个job由于触发器的触发，会产生许多的构建记录，所以这个选项可以让我们选择是否丢弃过时的构建记录。阈值的设置可以为日期（即丢弃X日前的构建记录）或数量（即只保存最新的X个构建记录）。</p>
</li>
<li><p><strong>Github project</strong></p>
<p>由<a href="http://wiki.jenkins-ci.org/display/JENKINS/Github+Plugin" target="_blank" rel="external">GitHub plugin</a>产生的选项，可以输入该job的github地址，从而可以在后面的trigger触发器中选择使用<strong>GitHub hook trigger for GITScm polling</strong>（当有更改push上github后触发触发器）</p>
</li>
<li><p><strong><em>This</em> project is parameterised</strong> </p>
<p>为这个job添加一些变量参数，当执行构建或触发触发器而构建的时候，使用到这些参数，从而实现不同的功能，参数的设定可以由默认值，当该项被勾选后，Build Now<em>会变更为Build with Parameters</em>，需要键入相应的参数</p>
</li>
</ul>
<ul>
<li><p><strong>Throttle builds</strong></p>
<p>由 <a href="http://wiki.jenkins-ci.org/display/JENKINS/Branch+API+Plugin" target="_blank" rel="external">Branch API Plugin</a>产生的选项，对于构建进行一个最小时间间隔的强制设定，例如一天最多构建6次job。但是这个选项<strong>不会</strong>让job在时间段内<strong>平均</strong>构建，例如设置了一天6次，但是不是每隔4个小时就执行一次。</p>
</li>
<li><p><strong>Disable this project</strong></p>
<p>暂时关闭这个job，从而停止触发器的触发等操作。</p>
</li>
<li><p><strong>Execute concurrent builds if necessary</strong></p>
<p>勾选了这个选项，这个job并发的构建（例如同时点击数次Build Now）会异步进行构建。而默认非勾选情况下，是阻塞执行构建的。</p>
</li>
</ul>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins4.png" alt=""></p>
<p>然后就是代码仓库的管理选项了。</p>
<p>这个项目使用的是使用github作为代码仓库，所以我们选择第二个。（如使用SVN则选择第三个Subversion）</p>
<p>其中我们需要键入仓库的地址，对于github或者gitlab，我们需要使用非对称密钥对去进行身份验证，这里使用的是RSA算法生成的密钥。将jenkins所在本机生成的公钥填写入github或gitlab的密钥验证中，从而实现身份验证。</p>
<p>其中也需要选择远程仓库的分支，默认是master分支。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins5.png" alt=""></p>
<p>接下来是选择构建触发器的选项，当触发器的条件满足时，则对job进行构建</p>
<ul>
<li><p><strong>Trigger builds remotely (e.g., from scripts)</strong></p>
<p>在该选项设定一个token口令，使用脚本对该项目进行立刻构建指令</p>
<p><code>JENKINS_URL`/job/simple-python/build?token=`TOKEN_NAME` or /buildWithParameters?token=`TOKEN_NAME</code></p>
<p>尾部最好加上<code>&amp;cause=Cause+Text</code>对该次构建进行注释，方面翻查操作日志</p>
</li>
<li><p><strong>Build after other projects are built</strong></p>
<p>可以选择在一个或多个项目完成构建之后触发触发器，进行构建，熟练地使用该触发器，可以形成一个有效的pipeline工作链</p>
</li>
<li><p><strong>Build periodically</strong></p>
<p>周期性地对项目进行构建，使用的语法是<a href="http://blog.csdn.net/k_scott/article/details/8508290" target="_blank" rel="external">cron</a></p>
<p>例如 <em> </em> <em> </em> * 则代表每分钟进行一次构建</p>
</li>
<li><p><del><strong>GitHub hook trigger for GITScm polling</strong></del></p>
<p><del>上文所说到的，当github有更新时，进行构建</del>   暂时没研究怎么用，可以使用以下的<strong>Poll SCM</strong></p>
</li>
<li><p><strong>Poll SCM</strong></p>
<p>当使用非github作为远程仓库时，使用该触发器，周期性对远程仓库进行检测，当发现有更新时进行构建</p>
<p>使用的时间安排表语法也是<a href="http://blog.csdn.net/k_scott/article/details/8508290" target="_blank" rel="external">cron</a></p>
</li>
</ul>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins6.png" alt=""></p>
<p>接下来是一些构建时的，对环境的选项设置</p>
<ul>
<li><p><strong>Delete workspace before build starts</strong></p>
<p>默认是当开始新的构建时，对该job的工作空间进行全部删除，也可以通过设置，只删除某些文件</p>
</li>
<li><p><strong>Abort the build if it’s stuck</strong></p>
<p>可以设置某一个具体的超时时间，当构建阻塞超过超时时间后，对该构建进行中止</p>
</li>
<li><p><strong>Add timestamps to the Console Output</strong></p>
<p>添加时间戳到控制台输出</p>
</li>
<li><p><strong>Use secret text(s) or file(s)</strong></p>
<p>对文件或密码进行加密</p>
</li>
<li><p><strong>With Ant</strong></p>
<p>为Apache Ant搭建环境</p>
</li>
</ul>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins7.png" alt=""></p>
<p>接下来是根据需要进行构建的脚本编写，这里是测试一个简单的python程序，所以直接使用命令行语句</p>
<p><code>python test.py</code></p>
<p>其中还有一些例如代码质量管理的<strong>Sonar Gates</strong>会在后述解释</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins8.png" alt=""></p>
<p>最后还可以选择在构建完成之后做其他动作，例如构建其他的项目，形成一个pipeline。</p>
<p>这里没有使用。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins9.png" alt=""></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins10.png" alt=""></p>
<p>至此，这个job就简单设置完成了，每当检测到远程代码仓库有更新时，进行代码构建，输出到控制台。</p>
<p>这是一个简单的python程序。</p>
<h3 id="4-Jenkins的master-slave模型"><a href="#4-Jenkins的master-slave模型" class="headerlink" title="4. Jenkins的master-slave模型"></a>4. Jenkins的master-slave模型</h3><p><img src="http://images.cnblogs.com/cnblogs_com/itech/build/jenkinsslavetpye.PNG" alt=""></p>
<p>Jenkins也有分布式的构建，模式是master-slave的模型，master主管所有的job的运行情况。slave可以设置成不同的生产环境，master分配job到slave中，实现相应的操作。</p>
<p>Reference：</p>
<p>[1] <a href="http://blog.csdn.net/abcdocker/article/category/6638595" target="_blank" rel="external">持续集成 by www.abcdocker.com</a></p>
<p>[2] <a href="https://files.cnblogs.com/files/itech/Jenkins%E5%85%A5%E9%97%A8.pdf" target="_blank" rel="external">Jenkins入门 by itech</a></p>
<p>[3] <a href="http://www.yiibai.com/jenkins/jenkins_distributed_builds.html" target="_blank" rel="external">Jenkins分布式构建</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/09/19/other/html_notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/19/other/html_notes/" itemprop="url">
                  HTML学习笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-19T00:00:00+08:00">
                2017-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/html/" itemprop="url" rel="index">
                    <span itemprop="name">html</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h3><p>使用小写</p>
<p><code>&lt;br /&gt;</code> 是空行</p>
<p>浏览器会自动地在段落、标题的前后添加空行。（<code>&lt;p&gt; &lt;h1&gt;-&lt;h6&gt;</code>是块级元素）</p>
<p>避免使用<code>&lt;font&gt;</code>等标签了，使用style</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;h1&gt;Look! Styles and colors&lt;/h1&gt;</div><div class="line"></div><div class="line">&lt;p style=&quot;font-family:verdana;color:red&quot;&gt;</div><div class="line">This text is in Verdana and red&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p style=&quot;font-family:times;color:green&quot;&gt;</div><div class="line">This text is in Times and green&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;p style=&quot;font-size:30px&quot;&gt;This text is 30 pixels high&lt;/p&gt;</div></pre></td></tr></table></figure>
<p>header 中用meta重定向</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;head&gt;</div><div class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=gb2312&quot; /&gt;</div><div class="line">&lt;meta http-equiv=&quot;Refresh&quot; content=&quot;5;url=http://www.w3school.com.cn&quot; /&gt;</div><div class="line">&lt;/head&gt;</div></pre></td></tr></table></figure>
<p>小于号&lt; <code>&amp;lt;</code>  大于号&gt;<code>&amp;gt;</code>空格最好用 <code>&amp;nbsp;</code></p>
<p>上传超过一个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;form action=&quot;/example/html5/demo_form.asp&quot; method=&quot;get&quot;&gt;</div><div class="line">选择图片：&lt;input type=&quot;file&quot; name=&quot;img&quot; multiple=&quot;multiple&quot; /&gt;</div><div class="line">&lt;input type=&quot;submit&quot; /&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&lt;p&gt;请尝试在浏览文件时选取一个以上的文件。&lt;/p&gt;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/09/13/fs/fs3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/13/fs/fs3/" itemprop="url">
                  文件系统3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-13T14:23:06+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/filesystem/" itemprop="url" rel="index">
                    <span itemprop="name">filesystem</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Mongo-Connector-设置"><a href="#Mongo-Connector-设置" class="headerlink" title="Mongo Connector 设置"></a><a href="https://my.oschina.net/tianlele/blog/848860" target="_blank" rel="external">Mongo Connector 设置</a></h3><p>为ES添加pinyin搜索</p>
<p>google open search</p>
<p><a href="https://disq.us/url?url=https%3A%2F%2Faaronparecki.com%2F2011%2F07%2F11%2F3%2Fhow-to-let-google-power-opensearch-on-your-website%3AHsv8oJR1pwEePhD0jpqWGdgJoCU&amp;cuid=3833100" target="_blank" rel="external">https://aaronparecki.com/20…</a></p>
<h3 id="TIKA读取附件"><a href="#TIKA读取附件" class="headerlink" title="TIKA读取附件"></a>TIKA读取附件</h3><p>tika — help</p>
<p><strong>1.tika-python 调用</strong></p>
<p><a href="https://github.com/chrismattmann/tika-python" target="_blank" rel="external">tika-python</a>是python的一个第三方库，可以快捷地调用tika很实用</p>
<p>安装库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install tika</div></pre></td></tr></table></figure>
<p>第一次调用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tika</div><div class="line">tika.initVM()</div><div class="line"><span class="keyword">from</span> tika <span class="keyword">import</span> parser</div><div class="line"></div><div class="line">parsed = parser.from_file(<span class="string">r'/Users/alan/Downloads/1/1.pptx'</span>)</div><div class="line">print(parsed[<span class="string">"metadata"</span>])</div><div class="line">print(parsed[<span class="string">"content"</span>])</div></pre></td></tr></table></figure>
<p>会下载tika的整个java包，所以耗时较长，请耐心等待</p>
<p>下载完之后就可以直接使用，方便快捷</p>
<p>metadata包括以下数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">height</div><div class="line">tiff:ImageLength</div><div class="line">Data PlanarConfiguration</div><div class="line">resourceName</div><div class="line">tiff:BitsPerSample</div><div class="line">X-Parsed-By</div><div class="line">Compression Lossless</div><div class="line">width</div><div class="line">Compression NumProgressiveScans</div><div class="line">Transparency Alpha</div><div class="line">Chroma ColorSpaceType</div><div class="line">X-TIKA:parse_time_millis</div><div class="line">Compression CompressionTypeName</div><div class="line">Data BitsPerSample</div><div class="line">IHDR</div><div class="line">Data SampleFormat</div><div class="line">Chroma BlackIsZero</div><div class="line">Chroma NumChannels</div><div class="line">Dimension ImageOrientation</div><div class="line">embeddedRelationshipId</div><div class="line">X-TIKA:embedded_resource_path</div><div class="line">tiff:ImageWidth</div><div class="line">Content-Type</div><div class="line">Dimension PixelAspectRatio</div></pre></td></tr></table></figure>
<p>!使用tika-python会打开一个tika服务器（post文件进去返回解析的html），内存占用较大</p>
<p><strong>2.命令行调用</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar tika-app-1.16.jar --text doc</div></pre></td></tr></table></figure>
<p>doc是需要解析的文件路径</p>
<p>为了在node.js中内部调用，我们使用了child_process库</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">'child_process'</span>).exec;</div><div class="line"></div><div class="line">exec((<span class="string">'java -jar tika-app-1.16.jar --text '</span>+<span class="string">'/Users/alan/Downloads/1/bb.pdf'</span>),<span class="function"><span class="keyword">function</span>(<span class="params">error,stdout,stderr</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span> (error !== <span class="literal">null</span>)&#123;</div><div class="line">		<span class="built_in">console</span>.error(<span class="string">'error'</span>);</div><div class="line">	&#125;;</div><div class="line">	<span class="built_in">console</span>.log(stdout);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>3.服务器模式调用</strong></p>
<p>命令行启动服务器模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar tika-app-1.16.jar --server --port 12345</div></pre></td></tr></table></figure>
<p>这是简单的服务器模式启动，仅供测试环境使用</p>
<p>更完善的服务器模式tika看<a href="https://wiki.apache.org/tika/TikaJAXRS" target="_blank" rel="external">https://wiki.apache.org/tika/TikaJAXRS</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/09/12/mongo-fuzhiji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/12/mongo-fuzhiji/" itemprop="url">
                  MongoDB 复制集
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-12T14:24:00+08:00">
                2017-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mongodb/" itemprop="url" rel="index">
                    <span itemprop="name">mongodb</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="MongoDB复制集开启（本机）"><a href="#MongoDB复制集开启（本机）" class="headerlink" title="MongoDB复制集开启（本机）"></a>MongoDB复制集开启（本机）</h3><p>在本地开启三个mongod，当作三个服务器，分别使用作<strong>主复制集、从复制集、仲裁复制集</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:28001   //主复制集</div><div class="line">127.0.0.1:28002   //从复制集</div><div class="line">127.0.0.1:28003   //仲裁复制集</div></pre></td></tr></table></figure>
<p><strong>1.首先建立三个文件夹分别存放数据库数据文件。</strong></p>
<p><strong>2.分别建立各自的conf配置文件</strong></p>
<p>配置内容如下：（三个服务器只是端口不同，其他配置相同）</p>
<p>/data/mongodb/conf/28001.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># 端口</div><div class="line">port=28001</div><div class="line"># 绑定ip地址</div><div class="line">bind_ip=127.0.0.1</div><div class="line"># 日志文件路径</div><div class="line">logpath=/data/mongodb/log/28001.log</div><div class="line"># 数据文件存放目录</div><div class="line">dbpath=/data/mongodb/data/28001/</div><div class="line"># 以追加的方式写日志</div><div class="line">logappend=true</div><div class="line"></div><div class="line">pidfilepath=/data/mongodb/data/28001/28001.pid</div><div class="line">fork=true</div><div class="line">oplogSize=1024</div><div class="line"># 复制集名称</div><div class="line">replSet=MyMongo</div></pre></td></tr></table></figure>
<p>其中复制集名称最重要，因为如果需要放在同一个复制集，必须保证不同的服务器的复制集名称完全相同。（<font color="red">其中replSet的S记得要大写</font>）</p>
<p><strong>3.启动三个服务器</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mongod -f /data/mongodb/conf/28001.conf</div><div class="line">mongod -f /data/mongodb/conf/28002.conf</div><div class="line">mongod -f /data/mongodb/conf/28003.conf</div></pre></td></tr></table></figure>
<p>后面跟的是配置文件的地址，启动完成后，会出现一个fork:successful的提示信息，而且不是在前台启动的，所以要注意，可能已经启动过了。</p>
<p>查找是否有启动可以使用以下命令查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps -ef | grep mongo</div></pre></td></tr></table></figure>
<p><strong>4.初始化复制集</strong></p>
<p>如果是第一次进行初始化，进入需要成为主复制集的服务器，这里进入28001端口</p>
<p>进入mongo客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongo localhost:28001</div></pre></td></tr></table></figure>
<p>然后输入初始化命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rs.initiate(&#123;_id:&apos;MyMongo&apos;,members:[&#123;_id:1,host:&apos;127.0.0.1:28001&apos;&#125;]&#125;)</div></pre></td></tr></table></figure>
<p>第一个_id：复制集的名称</p>
<p>member：复制集服务器列表（因为其他服务器还没完成初始化，所以只有一个当前的服务器）</p>
<p>第二个_id：指定给服务器的ID</p>
<p>host：服务器主机地址</p>
<p><strong>5.添加从复制集合仲裁复制集</strong></p>
<p>完成初始化，可以看到，当前服务器的名称已经成为了primary。因为是整个复制集中第一个完成初始化的，所以该服务器成为主复制集。</p>
<p>然后我们需要添加从复制集：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rs.add(&apos;127.0.0.1:28002&apos;)</div></pre></td></tr></table></figure>
<p>{”ok“ : 1}添加成功</p>
<p>调用rs.status()可以查看到复制集的情况</p>
<p>然后我们添加仲裁复制集：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rs.addArb(&apos;127.0.0.1:28003&apos;)</div></pre></td></tr></table></figure>
<p>{”ok“ : 1}添加成功</p>
<p><strong>6.测试</strong></p>
<p>Ref:</p>
<p>[1] <a href="http://www.cnblogs.com/nicolegxt/p/6841442.html?utm_source=itdadao&amp;utm_medium=referral" target="_blank" rel="external">http://www.cnblogs.com/nicolegxt/p/6841442.html?utm_source=itdadao&amp;utm_medium=referral</a></p>
<p>[2] <a href="http://blog.csdn.net/lichangzai/article/details/50903130" target="_blank" rel="external">http://blog.csdn.net/lichangzai/article/details/50903130</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ondsf10qe.bkt.clouddn.com/avatar01.png"
               alt="Alan Wong" />
          <p class="site-author-name" itemprop="name">Alan Wong</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/alanhuangym" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alan Wong</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
