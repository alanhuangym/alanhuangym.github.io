<!doctype html>




<html class="theme-next pisces" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Note down something">
<meta property="og:url" content="http://www.pirrla.cn/index.html">
<meta property="og:site_name" content="Note down something">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Note down something">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":true},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.pirrla.cn/"/>





  <title> Note down something </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Note down something</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2018/03/28/reading/machinelearningbyzhouzhihua/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/28/reading/machinelearningbyzhouzhihua/" itemprop="url">
                  机器学习-周志华 笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-28T00:00:00+08:00">
                2018-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/reading/" itemprop="url" rel="index">
                    <span itemprop="name">reading</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="第1章-绪论"><a href="#第1章-绪论" class="headerlink" title="第1章 绪论"></a>第1章 绪论</h3><h4 id="监督学习："><a href="#监督学习：" class="headerlink" title="监督学习："></a>监督学习：</h4><p>欲预测的是离散值：分类（classification）</p>
<p>欲预测的是连续值：回归（regression）</p>
<h4 id="无监督学习："><a href="#无监督学习：" class="headerlink" title="无监督学习："></a>无监督学习：</h4><p>聚类clustering</p>
<p>泛化generalization</p>
<p>样本空间”独立同分布”independent and identically distributed i.i.d.</p>
<p>假设hypothesis</p>
<h4 id="奥卡姆剃刀（Occam’s-razor）原则"><a href="#奥卡姆剃刀（Occam’s-razor）原则" class="headerlink" title="奥卡姆剃刀（Occam’s razor）原则"></a>奥卡姆剃刀（Occam’s razor）原则</h4><p>若有多个假设与观察一致，则选最简单的那个</p>
<h3 id="第二章-模型评估与选择"><a href="#第二章-模型评估与选择" class="headerlink" title="第二章 模型评估与选择"></a>第二章 模型评估与选择</h3><h4 id="过拟合overfitting"><a href="#过拟合overfitting" class="headerlink" title="过拟合overfitting"></a>过拟合overfitting</h4><p>学习器把训练样本本身的一些特点当作了所有潜在样本都会具有的一般性质，导致泛化性能下降</p>
<p>因素：学习能力过于强大</p>
<p>解决：过拟合无法避免，能“缓解”，各个算法有不同的解决方法</p>
<h4 id="欠拟合underfitting"><a href="#欠拟合underfitting" class="headerlink" title="欠拟合underfitting"></a>欠拟合underfitting</h4><p>相对于过拟合，对训练样本的一般性质尚未学好</p>
<p>因素：学习能力低下</p>
<p>解决：增加训练轮数</p>
<h4 id="训练集"><a href="#训练集" class="headerlink" title="训练集"></a>训练集</h4><p>测试集应该尽可能与训练集互斥</p>
<p>划分方法：</p>
<ol>
<li><p>留出法hold-out</p>
<p>直接将数据集，根据比例，划分成两个互斥的集合，一个做训练集，一个做测试集</p>
</li>
<li><p>交叉验证法cross validation</p>
<p>将数据集划分为k个大小相同的互斥子集</p>
<p>进行k次训练，每次取k-1个子集作为训练集，余下的做测试集</p>
<p>最终取k次训练结果的平均值</p>
<p>又称“k折交叉验证” k-fold cross validation</p>
<p>k最常取值为10</p>
<p>同时，由于将数据集划分为子集有多种划分方式，为了减少因样本划分带来的误差，k折交叉验证通常要使用不同的划分方式重复p次</p>
<p>例如最常用的“10次10折交叉验证”</p>
</li>
<li><p>自助法 bootstrapping</p>
<p>以自助采样法(bootstrapping sampling)为基础</p>
<p>每次随机从数据集中挑选一个样本，获得其拷贝，然后将样本放回数据集</p>
<p>这个过程重复m次后，得到了一个包含m个数据的数据集</p>
<p>虽然有可能一些数据重复出现，一些数据没出现</p>
<p>适用于数据集较小或难以划分训练测试集的情形</p>
<p>也可以从初始数据集，产生多个不同的训练集</p>
</li>
</ol>
<h4 id="调参-parameter-tuning"><a href="#调参-parameter-tuning" class="headerlink" title="调参 parameter tuning"></a>调参 parameter tuning</h4><p>算法的参数称为“超参数”hypterparameter，通常不多</p>
<p>模型的参数，称为参数parameter，通常很多</p>
<font color="red">在模型选择完成后，学习算法和参数配置已经选定之后，我们应该使用数据集重新训练模型，使用所有的样本，从而形成最终提交给用户的模型</font>

<p>在研究对比不同算法的泛化性能时</p>
<p>使用在测试集上的判别效果来估计模型的实际泛化能力</p>
<p>而把训练数据再分为训练集和验证集，基于验证集来进行该算法的模型选择和调参</p>
<h4 id="性能度量"><a href="#性能度量" class="headerlink" title="性能度量"></a>性能度量</h4><table>
<thead>
<tr>
<th>混淆矩阵confusion matrix</th>
<th>预测结果</th>
<th>预测结果</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>真实情况</strong></td>
<td>正例</td>
<td>反例</td>
</tr>
<tr>
<td>正例</td>
<td>TP(真正例)</td>
<td>FN(假反例)</td>
</tr>
<tr>
<td>反例</td>
<td>FP(假正例)</td>
<td>TN(真反例)</td>
</tr>
</tbody>
</table>
<p>查准率（准确率）precision</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">P = \frac&#123;TP&#125;&#123;TP+FP&#125;</div></pre></td></tr></table></figure>
<p>查全率（召回率）recall</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">R = \frac&#123;TP&#125;&#123;TP+FN&#125;</div></pre></td></tr></table></figure>
<p>P-R曲线 纵轴P，横轴R，调整阈值的大小画出</p>
<p>不同的学习器，包住的面积越大，性能越好</p>
<p>或者平衡点，Break-Even Point，在45°角的线上，曲线的值，越大越好</p>
<p>或者F1得分</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">F1 = \frac&#123;2*P*R&#125;&#123;P+R&#125;</div></pre></td></tr></table></figure>
<p>当我们需要对查全/差准有一定偏向的时候，我们使用F1的一般形式</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">F_&#123;\beta&#125; = \frac&#123;(1+\beta^2)*P*R&#125;&#123;(\beta^2*P)+R&#125;</div><div class="line"></div><div class="line">\beta&gt;<span class="number">1</span>时查全率更重要</div><div class="line">\beta&lt;<span class="number">1</span>时查准率更重要</div><div class="line">\bata=<span class="number">1</span> 即F1 score</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2018/01/24/zentao/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/24/zentao/" itemprop="url">
                  禅道二次开发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-24T00:00:00+08:00">
                2018-01-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zentao/" itemprop="url" rel="index">
                    <span itemprop="name">zentao</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-禅道安装"><a href="#1-禅道安装" class="headerlink" title="1.禅道安装"></a>1.禅道安装</h3><p>因为省去配置APACHE和MySQL等环境，我们直接使用docker镜像进行二次开发，也方便了开发成果的后续转移和部署。</p>
<p>使用的是<a href="http://www.zentao.net/thread/87209.html" target="_blank" rel="external">官方论坛idoop的镜像</a>。版本号是<font color="red">9.8stable</font></p>
<p>运行命令是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 8085:80 -p 3307:3306 \</div><div class="line">        -e USER=“alan” -e PASSWD=&quot;password&quot; \</div><div class="line">        -e BIND_ADDRESS=“false” \</div><div class="line">        -v /Users/alan/zentao/zbox/:/opt/zbox/ \</div><div class="line">        --name zentao-server \</div><div class="line">        idoop/zentao</div></pre></td></tr></table></figure>
<h4 id="1-1-进入docker系统"><a href="#1-1-进入docker系统" class="headerlink" title="1.1 进入docker系统"></a>1.1 进入docker系统</h4><p>可以通过命令，进入docker系统命令行界面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker exec -it 容器ID /bin/bash</div></pre></td></tr></table></figure>
<h4 id="1-2-MySQL"><a href="#1-2-MySQL" class="headerlink" title="1.2 MySQL"></a>1.2 MySQL</h4><p>docker容器内的mysql可以通过</p>
<p>命令行<code>/opt/zbox/bin/mysql -u root -P 3306 -p</code>启动，密码默认是<code>123456</code></p>
<h4 id="1-3-APACHE"><a href="#1-3-APACHE" class="headerlink" title="1.3 APACHE"></a>1.3 APACHE</h4><p>通过<code>/opt/zbox/zbox restart</code>可以对APACHE和MySQL进行重启操作。</p>
<h4 id="1-4-MVC结构分析"><a href="#1-4-MVC结构分析" class="headerlink" title="1.4 MVC结构分析"></a>1.4 MVC结构分析</h4><p>文件结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line">$ tree -L 2</div><div class="line">.</div><div class="line">├── VERSION</div><div class="line">├── bin</div><div class="line">│   ├── init.bat</div><div class="line">│   ├── init.sh</div><div class="line">│   ├── php</div><div class="line">│   └── ztcli</div><div class="line">├── config</div><div class="line">│   ├── config.php</div><div class="line">│   ├── filter.php</div><div class="line">│   ├── my.php</div><div class="line">│   └── zentaopms.php</div><div class="line">├── db</div><div class="line">├── doc</div><div class="line">│   ├── CHANGELOG</div><div class="line">│   ├── COPYING</div><div class="line">│   ├── COPYING.LESSER</div><div class="line">│   ├── FLOWCHART.url</div><div class="line">│   ├── HELP.url</div><div class="line">│   ├── INSTALL</div><div class="line">│   ├── LICENSE</div><div class="line">│   ├── README</div><div class="line">│   ├── README.zh_CN</div><div class="line">│   ├── THANKS</div><div class="line">│   ├── THIRDPARTY</div><div class="line">│   ├── TODO</div><div class="line">│   ├── UPGRADE</div><div class="line">│   └── VIDEO.url</div><div class="line">├── framework</div><div class="line">│   ├── base</div><div class="line">│   ├── control.class.php</div><div class="line">│   ├── helper.class.php</div><div class="line">│   ├── model.class.php</div><div class="line">│   └── router.class.php</div><div class="line">├── lib</div><div class="line">│   ├── api</div><div class="line">│   ├── base</div><div class="line">│   ├── crontab</div><div class="line">│   ├── dao</div><div class="line">│   ├── date</div><div class="line">│   ├── filter</div><div class="line">│   ├── front</div><div class="line">│   ├── hyperdown</div><div class="line">│   ├── mobile</div><div class="line">│   ├── pager</div><div class="line">│   ├── pclzip</div><div class="line">│   ├── phpmailer</div><div class="line">│   ├── pinyin</div><div class="line">│   ├── purifier</div><div class="line">│   ├── qrcode</div><div class="line">│   ├── sendcloud</div><div class="line">│   ├── snoopy</div><div class="line">│   ├── spyc</div><div class="line">│   ├── ubb</div><div class="line">│   ├── zdb</div><div class="line">│   ├── zfile</div><div class="line">│   └── ztcloud</div><div class="line">├── module</div><div class="line">│   ├── action</div><div class="line">│   ├── admin</div><div class="line">│   ├── api</div><div class="line">│   ├── attendance</div><div class="line">│   ├── backup</div><div class="line">│   ├── block</div><div class="line">│   ├── branch</div><div class="line">│   ├── bug</div><div class="line">│   ├── build</div><div class="line">│   ├── common</div><div class="line">│   ├── company</div><div class="line">│   ├── convert</div><div class="line">│   ├── cron</div><div class="line">│   ├── custom</div><div class="line">│   ├── datatable</div><div class="line">│   ├── dept</div><div class="line">│   ├── dev</div><div class="line">│   ├── doc</div><div class="line">│   ├── editor</div><div class="line">│   ├── entry</div><div class="line">│   ├── extension</div><div class="line">│   ├── file</div><div class="line">│   ├── git</div><div class="line">│   ├── group</div><div class="line">│   ├── index</div><div class="line">│   ├── install</div><div class="line">│   ├── mail</div><div class="line">│   ├── misc</div><div class="line">│   ├── my</div><div class="line">│   ├── offduty</div><div class="line">│   ├── product</div><div class="line">│   ├── productplan</div><div class="line">│   ├── project</div><div class="line">│   ├── qa</div><div class="line">│   ├── release</div><div class="line">│   ├── report</div><div class="line">│   ├── score</div><div class="line">│   ├── search</div><div class="line">│   ├── setting</div><div class="line">│   ├── sso</div><div class="line">│   ├── story</div><div class="line">│   ├── svn</div><div class="line">│   ├── task</div><div class="line">│   ├── testcase</div><div class="line">│   ├── testreport</div><div class="line">│   ├── testsuite</div><div class="line">│   ├── testtask</div><div class="line">│   ├── todo</div><div class="line">│   ├── tree</div><div class="line">│   ├── tutorial</div><div class="line">│   ├── upgrade</div><div class="line">│   ├── user</div><div class="line">│   └── webhook</div><div class="line">├── tmp</div><div class="line">│   ├── backup</div><div class="line">│   ├── cache</div><div class="line">│   ├── extension</div><div class="line">│   ├── log</div><div class="line">│   └── model</div><div class="line">└── www</div><div class="line">    ├── api.php</div><div class="line">    ├── checktable.php</div><div class="line">    ├── data</div><div class="line">    ├── favicon.ico</div><div class="line">    ├── index.php</div><div class="line">    ├── ioncube.php</div><div class="line">    ├── js</div><div class="line">    ├── robots.txt</div><div class="line">    └── theme</div></pre></td></tr></table></figure>
<p>mvc结构指的是每一个模块分为control\model\view三大块。</p>
<p>通常在control文件内编写处理逻辑</p>
<p>model内写具体的实现方法，control通过<code>$this-&gt;模块名-&gt;方法</code>去调用model的方法</p>
<p>view存储的是对应control文件内函数的展示页面，例如control.php文件的<code>index</code>函数的页面则存储在view文件夹的<code>index.html.php</code>中</p>
<font color="red">注意这里使用的是config里的PATH_INFO去处理URL，如果是使用get方式处理URL则不同。</font>

<p>如果我们通过url调用模块，这样都会调用control文件内的方法。</p>
<p>例如这里的attendance模块的话，url为<code>/zentao/attendance</code>这样就会调用control里的默认<code>index</code>函数进行展示，例如签到的话我们就会调用control文件里的<code>onduty</code>函数，url就为<code>/zentao/attendance-onduty</code>。</p>
<p>同时在url里还可以传递参数例如<code>/zentao/attendance-onduty-100</code>这样就传递了100这个参数。</p>
<h3 id="2-考勤系统开发"><a href="#2-考勤系统开发" class="headerlink" title="2.考勤系统开发"></a>2.考勤系统开发</h3><p>我们希望参考<a href="http://www.zentao.net/book/zentaobizhelp/268.html" target="_blank" rel="external">禅道企业版的考勤系统</a>，开发出一个适合我们的考勤系统。</p>
<h4 id="2-1-签到按钮"><a href="#2-1-签到按钮" class="headerlink" title="2.1 签到按钮"></a>2.1 签到按钮</h4><p>实现签到和签退的功能，首先我们需要在用户界面上添加两个按钮，分别让用户实现签到签退操作。效果如下</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/zentao1.png" alt=""></p>
<p>我们需要在顶部导航栏添加按钮，就需要在module文件夹中找到common模块，因为根据禅道的结构，头文件都放在common模块中。</p>
<p>找到<code>./module/common/view/header.html.php</code>，我们在html文件中，找到了顶部导航栏的信息</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">'pull-right'</span> <span class="attr">id</span>=<span class="string">'topnav'</span>&gt;</span>&lt;?php commonModel::printTopBar();?&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>所以我们再去<code>./module/common/model.php</code>中找到这个<code>printTopBar</code>方法。然后在适当的位置，加入以下代码，这里的判断主要是当用户是访客访问的时候，就不会有签到的按钮。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!$isGuest)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">echo</span> <span class="string">"&lt;a href='/zentao/attendance-onduty'&gt;上班签到&lt;/a&gt;"</span>;</div><div class="line">                <span class="keyword">echo</span> <span class="string">"&lt;a href='/zentao/attendance-offduty'&gt;下班签退&lt;/a&gt;"</span>;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>完成按钮之后，我们就需要对具体的签到方法进行实现。</p>
<h4 id="2-2-MySQL表设计"><a href="#2-2-MySQL表设计" class="headerlink" title="2.2 MySQL表设计"></a>2.2 MySQL表设计</h4><p>duty表 - 用于存储用户的签到时间和签到签退状态等信息</p>
<p>建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`duty`</span> (</div><div class="line">    -&gt;   <span class="string">`user_id`</span> <span class="built_in">char</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</div><div class="line">    -&gt;   <span class="string">`user_name`</span> <span class="built_in">char</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    -&gt;   <span class="string">`schedule_date`</span> <span class="built_in">date</span> ,</div><div class="line">    -&gt;   <span class="string">`check_time`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    -&gt;   <span class="string">`flag`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></div><div class="line">    -&gt; ) <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>user_id</th>
<th>user_name</th>
<th>schedule_date</th>
<th>check_time</th>
<th>flag</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>user_id - 用户的用户名</li>
<li>user_name - 用户的真实姓名</li>
<li>schedule_date - 该班次的日期</li>
<li>check_time - 签到/签退的具体时间</li>
<li>flag - 表明该次签到的性质（签到/签退）</li>
</ul>
<p>duty_schedule表 - 用于存储这一年的上班班次信息，即星期六日和国家规定节假日等信息</p>
<p>建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`duty_schedule`</span> (</div><div class="line">  <span class="string">`year`</span> <span class="built_in">smallint</span>(<span class="number">5</span>),</div><div class="line">  <span class="string">`month`</span> <span class="built_in">smallint</span>(<span class="number">5</span>),</div><div class="line">  <span class="string">`day`</span> <span class="built_in">smallint</span>(<span class="number">5</span>),</div><div class="line">  <span class="string">`weekday`</span> <span class="built_in">smallint</span>(<span class="number">5</span>),</div><div class="line">  <span class="string">`flag`</span> <span class="built_in">smallint</span>(<span class="number">5</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>year</th>
<th>month</th>
<th>day</th>
<th>weekday</th>
<th>flag</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>year - 该班次的年份</li>
<li>month - 该班次的月份</li>
<li>day - 该班次的日</li>
<li>weekday - 这一天是星期几，1—7分别代表星期一到星期日</li>
<li>flag - 该班次的上班是否标记，0代表不用上班，1代表要上班，用于管理员进行节假日管理时进行修改</li>
</ul>
<h4 id="2-3-按钮实现"><a href="#2-3-按钮实现" class="headerlink" title="2.3 按钮实现"></a>2.3 按钮实现</h4><p>在<code>./module</code>位置下，我们创建一个attendance文件夹，作为考勤系统的模块。</p>
<p>根据MVC架构，我们分别attendance文件夹创建<code>control.php</code>和<code>model.php</code>。</p>
<p>control.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">attendance</span> <span class="keyword">extends</span> <span class="title">control</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The construct function.</div><div class="line">     * </div><div class="line">     * <span class="doctag">@access</span> public</div><div class="line">     * <span class="doctag">@return</span> void</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">parent</span>::__construct();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">     </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onduty</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">      	<span class="comment"># 获取当前登录用户的账户ID</span></div><div class="line">        $userid = <span class="keyword">$this</span>-&gt;app-&gt;user-&gt;account;</div><div class="line">      	<span class="comment"># 调用model.php文件下的onduty函数</span></div><div class="line">        <span class="keyword">$this</span>-&gt;attendance-&gt;onduty($userid);</div><div class="line">        <span class="comment"># 调用JS脚本，弹出提示框提示签到成功</span></div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;meta http-equiv='Content-Type'' content='text/html; charset=utf-8'&gt;"</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script charset='utf-8' type='text/javascript'&gt;alert('签到成功')&lt;/script&gt;"</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;location.href='/zentao/my'&lt;/script&gt;"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offduty</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">      	<span class="comment"># 获取当前登录用户的账户ID</span></div><div class="line">        $userid = <span class="keyword">$this</span>-&gt;app-&gt;user-&gt;account;</div><div class="line">      	<span class="comment"># 调用model.php文件下的onduty函数</span></div><div class="line">        <span class="keyword">$this</span>-&gt;attendance-&gt;offduty($userid);</div><div class="line">      	<span class="comment"># 调用JS脚本，弹出提示框提示签到成功</span></div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;meta http-equiv='Content-Type'' content='text/html; charset=utf-8'&gt;"</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script charset='utf-8' type='text/javascript'&gt;alert('签退成功')&lt;/script&gt;"</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;location.href='/zentao/my'&lt;/script&gt;"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>model.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">attendanceModel</span> <span class="keyword">extends</span> <span class="title">model</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onduty</span><span class="params">($userid)</span></span></div><div class="line">    &#123;</div><div class="line">        $info-&gt;user_id        = $userid;</div><div class="line">        $info-&gt;user_name      = <span class="string">''</span>;</div><div class="line">        $info-&gt;schedule_date  = date(<span class="string">'Y-m-d'</span>);</div><div class="line">        $info-&gt;check_time     = date(<span class="string">'Y-m-d H:i:s'</span>);</div><div class="line">      	<span class="comment"># 标记 0为上班，1为下班</span></div><div class="line">        $info-&gt;flag           = <span class="number">0</span>;</div><div class="line">      	<span class="comment"># 插入数据库</span></div><div class="line">        <span class="keyword">$this</span>-&gt;dao-&gt;insert(<span class="string">'duty'</span>)-&gt;data($info)-&gt;exec();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dao-&gt;lastInsertID();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offduty</span><span class="params">($userid)</span></span></div><div class="line">    &#123;</div><div class="line">        $info-&gt;user_id        = $userid;</div><div class="line">        $info-&gt;user_name      = <span class="string">''</span>;</div><div class="line">        $info-&gt;schedule_date  = date(<span class="string">'Y-m-d'</span>);</div><div class="line">        $info-&gt;check_time     = date(<span class="string">'Y-m-d H:i:s'</span>);</div><div class="line">        $info-&gt;flag           = <span class="number">1</span>;</div><div class="line">      	<span class="comment">#插入数据库</span></div><div class="line">        <span class="keyword">$this</span>-&gt;dao-&gt;insert(<span class="string">'duty'</span>)-&gt;data($info)-&gt;exec();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dao-&gt;lastInsertID();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-4-权限管理"><a href="#2-4-权限管理" class="headerlink" title="2.4 权限管理"></a>2.4 权限管理</h4><p>这样界面上就有了签到按钮了，同时也可以向数据库插入数据了，但是当我们不是以管理身份登录的时候，就会出现类似的权限不足提示。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/zentao2.png" alt=""></p>
<p>这是因为我们二次开发的模块，默认的权限都是只有管理员的，我们需要为这个模块添加权限。</p>
<p>添加权限可以在“组织=&gt;权限”中的右上角“按模块分配权限”进行分配。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/zentao3.png" alt=""></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/zentao4.png" alt=""></p>
<p>但是新增加的模块是不会在这个列表中出现的，所以我们需要对这个列表进行修改，从而使到签到模块能在这里出现。</p>
<p>首先在路径<code>./module/group/ext/lang/zh-cn/</code>下建立attendance.php文件（如路径不存在则进行新建，文件名与模块名一致），内容如下，onduty和offduty分别对应attendance模块control.php内的两个函数名。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$lang-&gt;resource-&gt;attendance = <span class="keyword">new</span> stdclass();</div><div class="line">$lang-&gt;resource-&gt;attendance-&gt;onduty = <span class="string">'onduty'</span>; </div><div class="line">$lang-&gt;resource-&gt;attendance-&gt;offduty = <span class="string">'offduty'</span>;</div></pre></td></tr></table></figure>
<p><img src="http://ondsf10qe.bkt.clouddn.com/zentao5.jpg" alt=""></p>
<p>然后回到模块内部，新建文件<code>./module/attendance/lang/zh-cn.php</code>，如下填写，主要是控制该模块在权限分配页面显示的名称和具体函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$lang-&gt;attendance-&gt;common = <span class="string">'签到'</span>;</div><div class="line">$lang-&gt;attendance-&gt;onduty = <span class="string">'上班签到'</span>;</div><div class="line">$lang-&gt;attendance-&gt;offduty = <span class="string">'下班签退'</span>;</div><div class="line">$lang-&gt;attendance-&gt;methodOrder[<span class="number">5</span>]  = <span class="string">'onduty'</span>;</div><div class="line">$lang-&gt;attendance-&gt;methodOrder[<span class="number">6</span>]  = <span class="string">'offduty'</span>;</div></pre></td></tr></table></figure>
<p>这样就完成了权限分配页面的改造，管理员可以在页面上进行权限的分配了。</p>
<h3 id="3-考勤页面"><a href="#3-考勤页面" class="headerlink" title="3.考勤页面"></a>3.考勤页面</h3><p>当我们完成了用户界面的设计之后，就需要考虑实际的使用了。现在用户已经可以向duty表插入自己的签到信息，那么我们就需要根据签到信息去验证用户是否正常签到签退（迟到早退）。</p>
<h4 id="3-1-考勤菜单"><a href="#3-1-考勤菜单" class="headerlink" title="3.1 考勤菜单"></a>3.1 考勤菜单</h4><p>我们希望是在顶级的菜单中加入考勤页面。如下</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/zentao6.jpg" alt=""></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/zentao7.png" alt=""></p>
<p>根据<a href="http://www.zentao.net/book/zentaopmshelp/68.html" target="_blank" rel="external">文档</a>，我们知道菜单的定义在<code>./module/common/lang/zh-cn</code>语言文件中。了解了写法之后，我们通过在适当的位置新增以下代码，实现修改顶级菜单和模块菜单的目的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 主导航菜单。*/</span></div><div class="line">$lang-&gt;menu = <span class="keyword">new</span> stdclass();</div><div class="line">$lang-&gt;menu-&gt;my       = <span class="string">'&lt;i class="icon-home"&gt;&lt;/i&gt;&lt;span&gt; 我的地盘&lt;/span&gt;|my|index'</span>;</div><div class="line">$lang-&gt;menu-&gt;product  = $lang-&gt;productCommon . <span class="string">'|product|index'</span>;</div><div class="line">$lang-&gt;menu-&gt;project  = $lang-&gt;projectCommon . <span class="string">'|project|index'</span>;</div><div class="line">$lang-&gt;menu-&gt;qa       = <span class="string">'测试|qa|index'</span>;</div><div class="line">$lang-&gt;menu-&gt;doc      = <span class="string">'文档|doc|index'</span>;</div><div class="line">$lang-&gt;menu-&gt;report   = <span class="string">'统计|report|index'</span>;</div><div class="line">$lang-&gt;menu-&gt;company  = <span class="string">'组织|company|index'</span>;</div><div class="line">$lang-&gt;menu-&gt;admin    = <span class="string">'后台|admin|index'</span>;</div><div class="line">$lang-&gt;menu-&gt;attendance    = <span class="string">'办公考勤|attendance|index'</span>;</div><div class="line"></div><div class="line"><span class="comment">/* 办公考勤设置。*/</span></div><div class="line">$lang-&gt;attendance = <span class="keyword">new</span> stdclass();</div><div class="line">$lang-&gt;attendance-&gt;menu = <span class="keyword">new</span> stdclass();</div><div class="line">$lang-&gt;attendance-&gt;menu-&gt;account        = <span class="keyword">array</span>(<span class="string">'link'</span> =&gt; <span class="string">'&lt;span id="myname"&gt;&lt;i class="icon-user"&gt;&lt;/i&gt; %s'</span> . $lang-&gt;arrow . <span class="string">'&lt;/span&gt;'</span>, <span class="string">'fixed'</span> =&gt; <span class="keyword">true</span>);</div><div class="line">$lang-&gt;attendance-&gt;menu-&gt;attend         = <span class="string">'考勤|attendance|index'</span>;</div><div class="line">$lang-&gt;attendance-&gt;menu-&gt;attend2         = <span class="string">'请假|attendance|index2'</span>;</div><div class="line">$lang-&gt;attendance-&gt;menu-&gt;attend3         = <span class="string">'补班|attendance|index3'</span>;</div><div class="line">$lang-&gt;attendance-&gt;menu-&gt;attend4         = <span class="string">'加班|attendance|index4'</span>;</div><div class="line">$lang-&gt;attendance-&gt;menu-&gt;attend5         = <span class="string">'调休|attendance|index5'</span>;</div><div class="line">$lang-&gt;attendance-&gt;menu-&gt;attend6         = <span class="string">'节假日|attendance|index6'</span>;</div></pre></td></tr></table></figure>
<p>这里注意到，我们希望用户的账户名能出现在模块菜单中，所以使用了一个传递参数的菜单%s。这个参数在调用attendance模块的control.php文件的index函数时使用common::setMenuVars函数进行设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">  		<span class="comment"># 获取用户的ID</span></div><div class="line">        $userid = <span class="keyword">$this</span>-&gt;app-&gt;user-&gt;account;</div><div class="line">  		<span class="comment"># 通过setMenuVars函数，将用户ID传递到菜单中</span></div><div class="line">        common::setMenuVars(<span class="keyword">$this</span>-&gt;lang-&gt;attendance-&gt;menu, <span class="string">'account'</span>, $userid);</div><div class="line">  		<span class="comment"># 展示页面</span></div><div class="line"> 		<span class="keyword">$this</span>-&gt;display();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="3-2-页面设计"><a href="#3-2-页面设计" class="headerlink" title="3.2 页面设计"></a>3.2 页面设计</h4><p>初步的页面设置是这样的</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/zentao8.png" alt=""></p>
<p>首先我们需要进行一个班次的设定，例如每个星期六日都不需要上班等信息，我们通过构建一个函数，对duty_schedule表进行写入，在control.php文件对model.php文件进行调用</p>
<p>control.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 删除该年份旧的班次信息，重新创建。慎用！</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createschedule</span><span class="params">($year)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;attendance-&gt;create_schedule($year);</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;meta http-equiv='Content-Type'' content='text/html; charset=utf-8'&gt;"</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script charset='utf-8' type='text/javascript'&gt;alert('新建$&#123;year&#125;年日程成功')&lt;/script&gt;"</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;location.href='/zentao/attendance'&lt;/script&gt;"</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>model.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 重新创建该年份的全部班次信息</span></div><div class="line">    <span class="comment">// ！！！！（需要注意，该操作会先删除该年份的班次信息，请慎用）！！！！</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create_schedule</span><span class="params">($year)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;dao-&gt;delete()-&gt;from(<span class="string">'duty_schedule'</span>)-&gt;where(<span class="string">'year'</span>)-&gt;eq($year)-&gt;exec();</div><div class="line">        <span class="keyword">foreach</span>(range(<span class="number">1</span>,<span class="number">12</span>) <span class="keyword">as</span> $month)</div><div class="line">        &#123;</div><div class="line">            $days_in_month = date(<span class="string">'t'</span>,mktime(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,$month,<span class="number">1</span>,$year));</div><div class="line">            <span class="keyword">foreach</span>(range(<span class="number">1</span>,$days_in_month) <span class="keyword">as</span> $day)</div><div class="line">            &#123;</div><div class="line">                $data-&gt;year = $year;</div><div class="line">                $data-&gt;month = $month;</div><div class="line">                $data-&gt;day = $day;</div><div class="line">                $data-&gt;weekday = date(<span class="string">'N'</span>,mktime(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,$month,$day,$year));</div><div class="line">                <span class="keyword">if</span> ($data-&gt;weekday == <span class="number">6</span> || $data-&gt;weekday == <span class="number">7</span>) $data-&gt;flag = <span class="number">0</span>;</div><div class="line">                <span class="keyword">else</span> $data-&gt;flag = <span class="number">1</span>;</div><div class="line">                <span class="keyword">$this</span>-&gt;dao-&gt;insert(<span class="string">'duty_schedule'</span>)-&gt;data($data)-&gt;exec();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>然后，我们首先需要在数据库寻找该用户的签到信息，然后将相关的信息传递给前端。</p>
<p>control.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 展示考勤主页面</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 获取当前用户ID</span></div><div class="line">        $userid = <span class="keyword">$this</span>-&gt;app-&gt;user-&gt;account;</div><div class="line">        <span class="comment">// 调用函数，对菜单的一个参数进行传递，这里传递用户ID</span></div><div class="line">        common::setMenuVars(<span class="keyword">$this</span>-&gt;lang-&gt;attendance-&gt;menu, <span class="string">'account'</span>, $userid);</div><div class="line">        <span class="comment">// 获取该用户的考勤信息，并调用assign函数传递到前端页面</span></div><div class="line">        $records = <span class="keyword">$this</span>-&gt;attendance-&gt;get_records_by_userid($userid);</div><div class="line">        <span class="keyword">$this</span>-&gt;assign(<span class="string">"records"</span>,$records);  </div><div class="line">        <span class="comment">// 获取该年的班次信息，并调用assign函数传递到前端页面</span></div><div class="line">        $schedule = <span class="keyword">$this</span>-&gt;attendance-&gt;get_schedule(<span class="string">'2018'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;assign(<span class="string">"schedule"</span>,$schedule);  </div><div class="line">        <span class="comment">// 调用assign函数传递上班时间和下班时间等设置到前端页面</span></div><div class="line">        <span class="keyword">$this</span>-&gt;assign(<span class="string">"schedule_onduty_time"</span>,<span class="string">'8:30:00'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;assign(<span class="string">"schedule_offduty_time"</span>,<span class="string">'18:00:00'</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;display();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>然后我们就能在前端页面进行一些逻辑设定，然后就能展示了</p>
<p>view/index.html.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span> <span class="string">'../../common/view/header.html.php'</span>;<span class="meta">?&gt;</span></div><div class="line"></div><div class="line"><span class="meta">&lt;?php</span> </div><div class="line"><span class="comment">// 获取今日的年份、月份、日、星期几等信息</span></div><div class="line">$today_year = date(<span class="string">"Y"</span>);</div><div class="line">$today_month = date(<span class="string">"n"</span>);</div><div class="line">$today_day = date(<span class="string">"j"</span>);</div><div class="line">$today_weekday = date(<span class="string">'N'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 在数据库中获取今日最早的签到和最晚的签退信息，返回一个长度2的数组</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">cal_in_out</span><span class="params">($records,$this_day)</span></span></div><div class="line">&#123;</div><div class="line">    $in_arr = <span class="keyword">array</span>();</div><div class="line">    $out_arr = <span class="keyword">array</span>();</div><div class="line">    <span class="keyword">foreach</span> ($records <span class="keyword">as</span> $key=&gt;$value)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> ($value-&gt;schedule_date == $this_day)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> ($value-&gt;flag == <span class="number">0</span>) </div><div class="line">            &#123;</div><div class="line">                $in_arr[] = strtotime($value-&gt;check_time);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> ($value-&gt;flag == <span class="number">1</span>) </div><div class="line">            &#123;</div><div class="line">                $out_arr[] = strtotime($value-&gt;check_time);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(min($in_arr),max($out_arr));</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div><div class="line">&lt;!-- 选择框，选择需要展示的年份和月份 --&gt;</div><div class="line">&lt;div&gt;</div><div class="line">    &lt;select id=<span class="string">"select_year"</span> onchange=<span class="string">""</span>&gt;</div><div class="line">     &lt;option id=<span class="string">"Not_data1"</span>&gt;年份&lt;/option&gt;</div><div class="line">     &lt;option id=<span class="string">"2017"</span> &gt;<span class="number">2017</span>&lt;/option&gt;</div><div class="line">     &lt;option id=<span class="string">"2018"</span> &gt;<span class="number">2018</span>&lt;/option&gt;</div><div class="line">     &lt;option id=<span class="string">"2019"</span> &gt;<span class="number">2019</span>&lt;/option&gt;</div><div class="line">    &lt;/select&gt;</div><div class="line">    &lt;select id=<span class="string">"month"</span> onchange=<span class="string">""</span>&gt;</div><div class="line">     &lt;option id=<span class="string">"Not_data2"</span>&gt;月份&lt;/option&gt;</div><div class="line">    &lt;/select&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">&lt;!-- 展示签到信息的table表格 --&gt;</div><div class="line">&lt;table&gt;</div><div class="line">&lt;thead&gt;</div><div class="line">    &lt;tr&gt;</div><div class="line">        &lt;!-- 输出这个是今年的第几周 --&gt;</div><div class="line">        &lt;th&gt;第<span class="meta">&lt;?php</span> <span class="keyword">echo</span> date(<span class="string">'W'</span>); <span class="meta">?&gt;</span>周&lt;/th&gt;</div><div class="line">        &lt;th&gt;星期&lt;/th&gt;</div><div class="line">        &lt;th&gt;签到&lt;/th&gt;</div><div class="line">        &lt;th&gt;签退&lt;/th&gt;</div><div class="line">        &lt;th&gt;操作/状态&lt;/th&gt;</div><div class="line">    &lt;/tr&gt;</div><div class="line">&lt;/thead&gt;</div><div class="line">&lt;tbody &gt;</div><div class="line">    <span class="meta">&lt;?php</span></div><div class="line">    $a = <span class="keyword">array</span>(<span class="string">'一'</span>,<span class="string">'二'</span>,<span class="string">'三'</span>,<span class="string">'四'</span>,<span class="string">'五'</span>,<span class="string">'六'</span>,<span class="string">'日'</span>);</div><div class="line">    <span class="comment">// 用于循环的数组</span></div><div class="line">    $b = range(<span class="number">0</span>,<span class="number">6</span>);</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span>($b <span class="keyword">as</span> $key=&gt;$value)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 根据今日的日期，从这个星期的第一天开始输出日期，其他参数还有循环次数$b</span></div><div class="line">        $this_day = date(<span class="string">"Y-m-d"</span>,mktime(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,$today_month,$today_day+(<span class="number">1</span>-$today_weekday+$value),$today_year));</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;"</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;td&gt;$&#123;this_day&#125;&lt;/td&gt;"</span>;</div><div class="line">        <span class="comment">// 输出中文星期几</span></div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;td&gt;$a[$value]&lt;/td&gt;"</span>;</div><div class="line">        <span class="comment">// 获取该一行日期的签到信息，最早的签到信息和最晚的签退信息（这里有缺陷，无法控制超过晚上12点的信息）</span></div><div class="line">        $in_out = cal_in_out($records,$this_day);</div><div class="line">        <span class="comment">// 如果有签到信息，则输出签到信息</span></div><div class="line">        <span class="keyword">if</span> ($in_out[<span class="number">0</span>])  &#123;$onduty_time =date(<span class="string">"G:i:s"</span>,$in_out[<span class="number">0</span>]); <span class="keyword">echo</span> <span class="string">"&lt;td&gt;"</span>.$onduty_time.<span class="string">"&lt;/td&gt;"</span>;&#125;</div><div class="line">        <span class="keyword">else</span> </div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 如果没有，则输出空</span></div><div class="line">            $onduty_time = <span class="string">''</span>;</div><div class="line">            <span class="comment">// 如果是当天的话，出现一个马上签到的按钮，供签到</span></div><div class="line">            <span class="keyword">if</span>( date(<span class="string">"Y-m-d"</span>) == $this_day) <span class="keyword">echo</span> <span class="string">"&lt;td&gt;&lt;a href='/zentao/attendance-onduty'&gt;马上签到&lt;/a&gt;&lt;/td&gt;"</span>;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">"&lt;td&gt;&lt;/td&gt;"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 同签到一样</span></div><div class="line">        <span class="keyword">if</span> ($in_out[<span class="number">1</span>]) &#123;$offduty_time =date(<span class="string">"G:i:s"</span>,$in_out[<span class="number">1</span>]); <span class="keyword">echo</span> <span class="string">"&lt;td&gt;"</span>.$offduty_time.<span class="string">"&lt;/td&gt;"</span>;&#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            $offduty_time = <span class="string">''</span>;</div><div class="line">            <span class="keyword">if</span>( date(<span class="string">"Y-m-d"</span>) == $this_day) <span class="keyword">echo</span> <span class="string">"&lt;td&gt;&lt;a href='/zentao/attendance-offduty'&gt;马上签退&lt;/a&gt;&lt;/td&gt;"</span>;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">"&lt;td&gt;&lt;/td&gt;"</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;td&gt;"</span>;</div><div class="line">        <span class="comment">// 处理日期在今天之前的信息的显示状态</span></div><div class="line">        <span class="keyword">if</span> (strtotime($this_day) &lt;= strtotime(date(<span class="string">"Y-m-d"</span>)))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 在班次表里面寻找当天的班次信息，例如是否法定节假日等</span></div><div class="line">            <span class="keyword">foreach</span>($schedule <span class="keyword">as</span> $s)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (strtotime($s-&gt;year.<span class="string">'-'</span>.$s-&gt;month.<span class="string">'-'</span>.$s-&gt;day) == strtotime($this_day))</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">// 如果需要上班，则进行时间校验，查看是否迟到早退</span></div><div class="line">                    <span class="keyword">if</span> ($s-&gt;flag == <span class="number">1</span>)</div><div class="line">                    &#123;</div><div class="line">                        <span class="comment">// 如果有签到信息的话，不算缺勤</span></div><div class="line">                        <span class="keyword">if</span> ($onduty_time &amp;&amp; $offduty_time)</div><div class="line">                        &#123;</div><div class="line">                            <span class="comment">// 通过一个flag去区分不同的状态</span></div><div class="line">                            $status_flag = <span class="number">0</span>;</div><div class="line">                            <span class="keyword">if</span> (strtotime($onduty_time) &gt; strtotime($schedule_onduty_time))  &#123;$status_flag+=<span class="number">1</span>;&#125;</div><div class="line">                            <span class="keyword">if</span> (strtotime($offduty_time) &lt; strtotime($schedule_offduty_time)) &#123;$status_flag+=<span class="number">2</span>;&#125;</div><div class="line">                            <span class="keyword">if</span> ($status_flag == <span class="number">0</span>) <span class="keyword">echo</span> <span class="string">"正常"</span>;</div><div class="line">                            <span class="keyword">elseif</span> ($status_flag == <span class="number">1</span>) <span class="keyword">echo</span> <span class="string">"迟到"</span>;</div><div class="line">                            <span class="keyword">elseif</span> ($status_flag == <span class="number">2</span>) <span class="keyword">echo</span> <span class="string">"早退"</span>;</div><div class="line">                            <span class="keyword">elseif</span> ($status_flag == <span class="number">3</span>) <span class="keyword">echo</span> <span class="string">"迟到早退"</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// 没有签到信息，且不是当日的话，记缺勤</span></div><div class="line">                        <span class="keyword">elseif</span> (strtotime($this_day) != strtotime(date(<span class="string">"Y-m-d"</span>))) <span class="keyword">echo</span> <span class="string">"缺勤"</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 如果当天不需要上班</span></div><div class="line">                    <span class="keyword">if</span> ($s-&gt;flag == <span class="number">0</span>)</div><div class="line">                    &#123;</div><div class="line">                        <span class="comment">// 如果有签到信息，则算加班</span></div><div class="line">                        <span class="keyword">if</span>($onduty_time &amp;&amp; $offduty_time)</div><div class="line">                        &#123;</div><div class="line">                            $hours = (strtotime($offduty_time)-strtotime($onduty_time))/<span class="number">3600</span>;</div><div class="line">                            <span class="keyword">echo</span> <span class="string">"加班$&#123;hours&#125;小时"</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// 否则正常</span></div><div class="line">                        <span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">"正常"</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 停止班次寻找的循环</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;/td&gt;"</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&lt;/tr&gt;"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">?&gt;</span></div><div class="line">&lt;/tbody&gt;</div><div class="line">&lt;/table&gt;</div><div class="line"></div><div class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span> <span class="string">'../../common/view/footer.html.php'</span>;<span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>当然也需要进行权限设定，才能让非管理员用户展示出来，方法同上。</p>
<p>References:</p>
<p>[1] <a href="http://www.zentao.net/book/zentaopmshelp/257.html" target="_blank" rel="external">如何登记权限</a></p>
<p>[2] <a href="[http://devel.cnezsoft.com/book/zentaophphelp.html](http://devel.cnezsoft.com/book/zentaophphelp.html">zentaoPHP框架基本使用手册</a>)</p>
<p>[3] <a href="[http://devel.cnezsoft.com/book/extension.html](http://devel.cnezsoft.com/book/extension.html">zentaoPHP框架二次开发机制</a>)</p>
<p>[4] <a href="http://www.zentao.net/book/zentaopmshelp/68.html" target="_blank" rel="external">如何登记菜单</a></p>
<p>[5] <a href="http://php.net/manual/en/function.date.php" target="_blank" rel="external">http://php.net/manual/en/function.date.php</a></p>
<p>[6] <a href="http://devel.cnezsoft.com/book/zentaophphelp/dao-17.html" target="_blank" rel="external">http://devel.cnezsoft.com/book/zentaophphelp/dao-17.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2018/01/12/jenkins/jenkins9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/12/jenkins/jenkins9/" itemprop="url">
                  Jenkins学习笔记9-部署其他语言的代码质量管理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-12T00:00:00+08:00">
                2018-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Javascript"><a href="#Javascript" class="headerlink" title="Javascript"></a>Javascript</h3><p>使用的是<a href="https://eslint.org" target="_blank" rel="external">ESLint</a>。</p>
<p>因为需要在服务器部署使用，所以根据指引，我们通过全局方式安装eslint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g eslint</div></pre></td></tr></table></figure>
<p>然后我们就需要安装相应的代码风格配置文件，同样因为是使用全局的eslint，所以安装这些配置文件也需要添加参数<code>-g</code>实现全局</p>
<p>这里我们选择使用airbnb的代码风格</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">npm install eslint-config-airbnb -g</div><div class="line">npm install eslint-plugin-jsx-a11y -g</div><div class="line">npm install eslint-plugin-import -g</div><div class="line">npm install eslint-plugin-react -g</div></pre></td></tr></table></figure>
<p>以上四个就是airbnb的代码风格配置文件，安装完成之后我们还需要在服务器的根目录(linux在<code>/</code>目录)上放置一个配置文件（使用<code>eslint —init</code>命令生成再移到根目录也可以）。名字为<code>.eslintrc.js</code>，内容为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="string">"extends"</span>: <span class="string">"airbnb"</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>然后就可以使用了。</p>
<p>脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">#########################################################</div><div class="line">#Javascript 文件</div><div class="line"></div><div class="line">if [[ $file_name = *.js ]]</div><div class="line">then</div><div class="line"></div><div class="line">eslint $file_name &gt; report.txt</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">problems_sentence=`cat report.txt | grep -m 1 &apos;[0-9]* problem[s]*&apos;`</div><div class="line">eslint_problems=`echo $problems_sentence | grep -o &apos;[0-9]* problem[s]*&apos; | grep -o &apos;[0-9]*&apos;`</div><div class="line">eslint_errors=`echo $problems_sentence | grep -o &apos;[0-9]* error[s]*&apos; | grep -o &apos;[0-9]*&apos;`</div><div class="line">eslint_warnings=`echo $problems_sentence | grep -o &apos;[0-9]* warning[s]*&apos; | grep -o &apos;[0-9]*&apos;`</div><div class="line"></div><div class="line"></div><div class="line">echo $file_name 程序共有$eslint_problems个问题，其中$eslint_errors个错误，$eslint_warnings个警告</div><div class="line"></div><div class="line">echo 程序分析报告:</div><div class="line">cat report.txt | tail -n +3</div><div class="line"></div><div class="line">if [[ $&#123;eslint_errors&#125; -ge 2 ]]</div><div class="line">then</div><div class="line">	echo &quot;该代码错误数量未通过（大于等于2个）&quot;</div><div class="line">	let flag=1</div><div class="line">else</div><div class="line">	echo &quot;该代码错误数量通过&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">if [[ $&#123;eslint_warnings&#125; -ge 5 ]]</div><div class="line">then</div><div class="line">	echo &quot;该代码警告数量未通过（大于等于5个）&quot;</div><div class="line">	let flag=1</div><div class="line">else</div><div class="line">	echo &quot;该代码警告数量通过&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">fi</div><div class="line">#Javascript 文件结束</div><div class="line">#########################################################</div></pre></td></tr></table></figure>
<p>gitlab的dockerfile需要新增加</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装eslint</span></div><div class="line"><span class="keyword">RUN</span> npm install -g eslint</div><div class="line"><span class="comment">#安装airbnb的风格插件 </span></div><div class="line"><span class="keyword">RUN</span> npm install eslint-config-airbnb -g</div><div class="line"><span class="keyword">RUN</span> npm install eslint-plugin-jsx-a11y -g</div><div class="line"><span class="keyword">RUN</span> npm install eslint-plugin-import -g</div><div class="line"><span class="keyword">RUN</span> npm install eslint-plugin-react -g</div><div class="line"><span class="comment">#放入配置文件.eslintrc.js</span></div><div class="line"><span class="keyword">RUN</span> cd /</div><div class="line"><span class="keyword">RUN</span> touch .eslintrc.js</div></pre></td></tr></table></figure>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>我们使用<a href="https://pmd.github.io/" target="_blank" rel="external">PWD</a>去实现Java的静态检查。</p>
<p>dockerfile 新增以下内容，由于gitlab没有java环境，我们还需要配置java环境</p>
<p>(/etc/profile文件需要添加java文件)</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###把jdk添加到容器内目录</span></div><div class="line"><span class="keyword">ADD</span> ./jdk-8u131-linux-x64.tar.gz  /usr/local/</div><div class="line"></div><div class="line"><span class="comment">###配置jdk环境变量</span></div><div class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/jdk1.<span class="number">8.0</span>_131</div><div class="line"><span class="keyword">ENV</span> PATH /usr/local/jdk1.<span class="number">8.0</span>_131/bin:/home/maven/apache-maven-<span class="number">3.3</span>.<span class="number">9</span>/bin:/usr/local/jdk1.<span class="number">8.0</span>_131/bin:/usr/local/jdk1.<span class="number">8.0</span>_131/bin:/sbin:/usr/sbin:/bin:/usr/bin</div><div class="line"><span class="keyword">ENV</span> PATH $JAVA_HOME/bin:$PATH</div><div class="line"><span class="keyword">ENV</span> CLASSPATH .:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">RUN</span> cd $HOME</div><div class="line"><span class="keyword">RUN</span> wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.0.0/pmd-bin-6.0.0.zip</div><div class="line"><span class="keyword">RUN</span> unzip pmd-bin-6.0.0.zip</div><div class="line"><span class="comment">#RUN alias pmd="$HOME/pmd-bin-6.0.0/bin/run.sh pmd"</span></div></pre></td></tr></table></figure>
<p>同时脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">#########################################################</div><div class="line">#Java 文件</div><div class="line"></div><div class="line">if [[ $file_name = *.java ]]</div><div class="line">then</div><div class="line">#激活java环境</div><div class="line">source /etc/profile</div><div class="line">#运行PMD对代码进行静态检查，输出报告到report.txt中</div><div class="line">/home/git/pmd-bin-6.0.0/bin/run.sh pmd -d $file_name -f text -R java-basic,java-design &gt; report.txt</div><div class="line"></div><div class="line"></div><div class="line">echo 程序分析报告:</div><div class="line">#输出报告，但是报告中带有比较多的路径信息，所以进行正则匹配删除</div><div class="line">cat report.txt | sed &apos;s/\/home\/git\/data\/repositories\/.*\/.*.git\/temp_files\///g&apos;</div><div class="line">#返回代码报告的警告和错误共有多少个，如果超过一定程度则不通过</div><div class="line">java_count=`cat report.txt | wc -l`</div><div class="line"># 如果错误和警告大于等于5个，则不通过检查</div><div class="line">if [[ $&#123;java_count&#125; -ge 5 ]]</div><div class="line">then</div><div class="line">	echo &quot;该代码错误警告数量未通过（大于等于5个）&quot;</div><div class="line">	let flag=1</div><div class="line">else</div><div class="line">	echo &quot;该代码错误警告数量通过&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">fi</div><div class="line">#Java 文件结束</div><div class="line">#########################################################</div></pre></td></tr></table></figure>
<h3 id="CSS检查"><a href="#CSS检查" class="headerlink" title="CSS检查"></a>CSS检查</h3><p>我们使用<a href="https://stylelint.io/" target="_blank" rel="external">stylelint</a>作为css和html文件的检查工具</p>
<p>因为在服务器使用，所以首先使用npm安装相应的包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#安装stylelint主体</div><div class="line">npm install -g stylelint</div><div class="line">#安装推荐的设置</div><div class="line">npm install -g stylelint-config-standard</div></pre></td></tr></table></figure>
<p>然后我们需要建立一个配置文件<code>.stylelintrc</code>文件，但是由于是全局配置，所以我们需要找到npm的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 找到npm的位置</div><div class="line">npm root -g</div></pre></td></tr></table></figure>
<p>返回<code>/usr/lib/node_modules</code></p>
<p>然后<code>.stylelintrc</code>文件放在一个位置（我选择<code>/home/git</code>），内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;extends&quot;: &quot;/usr/lib/node_modules/stylelint-config-standard&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#########################################################</div><div class="line"># CSS和HTML 文件</div><div class="line">if [[ $file_name = *.html || $file_name = *.css ]]</div><div class="line">then</div><div class="line"></div><div class="line">stylelint $file_name &gt; report.txt</div><div class="line"></div><div class="line">style_count=`cat report.txt | wc -l`</div><div class="line"></div><div class="line">echo &quot;程序分析报告(大于30行的只显示前30行):&quot;</div><div class="line">#输出报告</div><div class="line">cat report.txt | head -n 30</div><div class="line"></div><div class="line">if [[ $&#123;style_count&#125; -ge 10 ]]</div><div class="line">then</div><div class="line">	echo &quot;该代码错误警告数量未通过（大于等于10个）&quot;</div><div class="line">	let flag=1</div><div class="line">else</div><div class="line">	echo &quot;该代码错误警告数量通过&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">fi</div><div class="line"># CSS和HTML文件结束</div><div class="line">#########################################################</div></pre></td></tr></table></figure>
<p>dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#安装stylelint主体</span></div><div class="line"><span class="keyword">RUN</span> npm install -g stylelint</div><div class="line"><span class="comment">#安装推荐的设置</span></div><div class="line"><span class="keyword">RUN</span> npm install -g stylelint-config-standard</div><div class="line"><span class="comment"># 把配置文件添加到某个路径中</span></div><div class="line"><span class="keyword">ADD</span> ./stylelintrc /home/git</div></pre></td></tr></table></figure>
<p>Reference:</p>
<p>[1] <a href="https://segmentfault.com/a/1190000005984309" target="_blank" rel="external">https://segmentfault.com/a/1190000005984309</a></p>
<p>[2] <a href="https://www.jianshu.com/p/83a5d4800250" target="_blank" rel="external">https://www.jianshu.com/p/83a5d4800250</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2018/01/05/jenkins/jenkins8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/05/jenkins/jenkins8/" itemprop="url">
                  Jenkins学习笔记8-Python服务的完整持续部署流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-05T00:00:00+08:00">
                2018-01-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>现在我们已经完成了整个流程的学习，现在我们应用一个简单的python服务，来测试一下效果。</p>
<h3 id="1-整体流程检视"><a href="#1-整体流程检视" class="headerlink" title="1. 整体流程检视"></a>1. 整体流程检视</h3><ol>
<li><p>搭建好相应的环境：</p>
<p>gitlab服务器、jenkins服务器、docker服务器、portainer监视docker服务器（和相应的redis等服务和数据库服务）</p>
</li>
<li><p>准备好一份需要维护和持续部署的代码</p>
</li>
<li><p>在gitlab服务器端写好钩子脚本，进行代码质量的把关</p>
</li>
<li><p>上传代码至gitlab远程仓库</p>
</li>
<li><p>在jenkins编写好联动docker的部署流程脚本和设置</p>
</li>
<li><p>等待jenkins触发，完成部署</p>
</li>
<li><p>检视部署效果</p>
</li>
</ol>
<p>业务流程如下：</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/uml1.png" alt=""></p>
<h3 id="2-Gitlab搭建"><a href="#2-Gitlab搭建" class="headerlink" title="2. Gitlab搭建"></a>2. Gitlab搭建</h3><h4 id="2-1-python代码预览"><a href="#2-1-python代码预览" class="headerlink" title="2.1 python代码预览"></a>2.1 python代码预览</h4><p>就是一个简单监听本地端口3002的python服务，然后返回一个html页面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#-*- coding:utf-8 -*-</span></div><div class="line"><span class="string">'''</span></div><div class="line"># author:alanhuang</div><div class="line"># create date: 2018.1.3</div><div class="line">'''</div><div class="line"><span class="keyword">import</span> BaseHTTPServer</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestHandler</span><span class="params">(BaseHTTPServer.BaseHTTPRequestHandler)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line">    处理请求并返回页面</div><div class="line">    '''</div><div class="line"></div><div class="line">    <span class="comment"># 页面模板</span></div><div class="line">    Page = <span class="string">'''\</span></div><div class="line">        &lt;html&gt;</div><div class="line">        &lt;body&gt;</div><div class="line">        &lt;p&gt;Hello, world!&lt;/p&gt;</div><div class="line">        &lt;/body&gt;</div><div class="line">        &lt;/html&gt;</div><div class="line">    '''</div><div class="line"></div><div class="line">    <span class="comment"># 处理一个GET请求</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">'''</span></div><div class="line">            用于处理GET请求</div><div class="line">        '''</div><div class="line">        self.send_response(<span class="number">200</span>)</div><div class="line">        self.send_header(<span class="string">"Content-Type"</span>, <span class="string">"text/html"</span>)</div><div class="line">        self.send_header(<span class="string">"Content-Length"</span>, str(len(self.Page)))</div><div class="line">        self.end_headers()</div><div class="line">        self.wfile.write(self.Page)</div><div class="line"></div><div class="line"><span class="comment">#----------------------------------------------------------------------</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    serverAddress = (<span class="string">''</span>, <span class="number">3002</span>)</div><div class="line">    server = BaseHTTPServer.HTTPServer(serverAddress, RequestHandler)</div><div class="line">    server.serve_forever()</div></pre></td></tr></table></figure>
<h4 id="2-2-gitlab"><a href="#2-2-gitlab" class="headerlink" title="2.2 gitlab"></a>2.2 gitlab</h4><p>gitlab的搭建过程我们就省略了，可以查看<a href="http://pirrla.cn/2017/12/23/jenkins/jenkins6/" target="_blank" rel="external">前文</a>。</p>
<p>我们直接到钩子编写的部分，我们在服务器端找到我们的项目，然后在服务器的<code>/git/data/repositories/root/test-python.git</code>项目目录中创建一个<code>custom_hooks</code>文件夹，然后在文件夹中新建一个可执行文件<code>update</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line"># 提交分支的名字</div><div class="line">ref_name=$1</div><div class="line"># 上一个commit的ID</div><div class="line">old_value=$2</div><div class="line"># 现在这个commit的ID</div><div class="line">new_value=$3</div><div class="line"></div><div class="line"># 共有四种状态</div><div class="line"># M-修改，A-新增，D-删除，RXXX-重命名 XXX是指重命名前后代码相似度</div><div class="line"># 所以这里选择修改和新增和重命名的进行代码审查</div><div class="line"># （因为重命名会覆盖掉D和M的状态</div><div class="line">new_and_modify=`git diff $old_value $new_value --raw | grep &quot;\sM\s\|\sA\s&quot; | awk &apos;&#123;print $4&quot;\t&quot;$6&#125;&apos; |  uniq`</div><div class="line">rename=`git diff $old_value $new_value --raw | grep &quot;\sR.*\s&quot; | awk &apos;&#123;print $4&quot;\t&quot;$7&#125;&apos; |  uniq`</div><div class="line"># 检查文件夹和文件的名字是否有空格</div><div class="line"># 有空格则直接提交失败</div><div class="line">count=`git show $new_value --name-only | grep &quot;\s&quot; -c`</div><div class="line">if [[ $count -gt 4 ]]</div><div class="line">then</div><div class="line">	echo &quot;文件/文件夹 名字包含空格，提交失败&quot;</div><div class="line">	exit 1</div><div class="line">fi</div><div class="line"></div><div class="line"># 将字符串变为数组</div><div class="line">new_and_modify_array=($new_and_modify)</div><div class="line">rename_array=($rename)</div><div class="line"></div><div class="line">collect_array=($&#123;new_and_modify_array[@]&#125; $&#123;rename_array[@]&#125;)</div><div class="line"></div><div class="line"># n用于遍历数组</div><div class="line">n=0</div><div class="line"># 遍历数组，提取出需要代码质量管理的文件的blob id和原本的文件名</div><div class="line">while [ $n -lt $&#123;#collect_array[@]&#125; ]</div><div class="line">do</div><div class="line">	# blob id 用于提取代码</div><div class="line">	blob_id=$&#123;collect_array[$n]:0:7&#125;</div><div class="line">	# 文件名，由于带有路径，所以将文件名中的/斜杠替换为_下划线</div><div class="line">	f_name=$&#123;collect_array[$&#123;n&#125;+1]////_&#125;</div><div class="line">	# 将代码保存到临时文件夹中</div><div class="line">	git show $blob_id &gt; temp_files/code_$&#123;f_name&#125;</div><div class="line">	# n自增，用于遍历</div><div class="line">	let n+=2</div><div class="line">done</div><div class="line"></div><div class="line"># 该标记用于识别是否有代码没用通过，全部通过则为0，只要有一个代码没通过就为1</div><div class="line">flag=0</div><div class="line"></div><div class="line"># 转换工作路径到临时文件夹</div><div class="line">cd temp_files</div><div class="line"># 获取临时文件夹里的文件</div><div class="line">files=`ls`</div><div class="line"># 如果临时文件夹里没有内容，则证明没有进行代码修改</div><div class="line"># 不需要进行代码管理，返回0</div><div class="line">if [[ $files == &quot;&quot; ]]</div><div class="line">then </div><div class="line">	exit 0</div><div class="line">fi</div><div class="line"></div><div class="line"># 将文件转换成数组，遍历数组，对每一个文件分别进行代码质量管理操作</div><div class="line">files_array=($files)</div><div class="line"># m用于遍历数组</div><div class="line">m=0</div><div class="line">files_count=$&#123;#files_array[@]&#125;</div><div class="line">echo &quot;此次提交共有 $files_count 个文件进行过修改/新增/重命名&quot;</div><div class="line"></div><div class="line">while [ $m -lt $&#123;#files_array[@]&#125; ]</div><div class="line">do</div><div class="line">	# 文件名</div><div class="line">	file_name=$&#123;files_array[$m]&#125;</div><div class="line">	let m+=1</div><div class="line"></div><div class="line"></div><div class="line">#########################################################</div><div class="line">#此处，不同语言应对不同的代码质量管理程序</div><div class="line">#主要操作是 `操作语句 $file_name` </div><div class="line">#例如python语言使用的是pylint，那么语句就是`pylint $file_name`</div><div class="line">#主要通过设定flag的值操作代码是否通过</div><div class="line">#########################################################</div><div class="line"></div><div class="line"></div><div class="line">#########################################################</div><div class="line">#Python 文件</div><div class="line">if [[ $file_name = *.py ]]</div><div class="line">then</div><div class="line"></div><div class="line"># 运行pylint脚本，对代码进行审查</div><div class="line"># 将报告输出在临时文件夹的report.txt中</div><div class="line">pylint $file_name  &gt; report.txt</div><div class="line"></div><div class="line"># 检测是否代码有语法错误，如果有语法错误直接退出</div><div class="line"># （因为有语法错误的话没有评分，无法与阈值比较</div><div class="line">error=`cat report.txt | grep &quot;syntax-error&quot;`</div><div class="line">if [[ $error != &quot;&quot; ]]</div><div class="line">then</div><div class="line">	echo $file_name &quot;有语法错误，提交失败&quot;</div><div class="line">	exit 1</div><div class="line">fi</div><div class="line"></div><div class="line"># 获取评分的语句</div><div class="line">score_senten=`cat report.txt | grep &quot;rated&quot; | awk &apos;&#123;print $7&#125;&apos;`</div><div class="line"></div><div class="line"># 从语句中提取分数</div><div class="line">if [[ &quot;$score_senten&quot; =~ (.*)/10 ]] </div><div class="line">then</div><div class="line">	score=&quot;$&#123;BASH_REMATCH[1]&#125;&quot;</div><div class="line">else</div><div class="line">	score=0</div><div class="line">fi</div><div class="line"></div><div class="line">echo $file_name 程序得分为 $score_senten</div><div class="line">echo 程序分析报告:</div><div class="line">cat report.txt</div><div class="line"></div><div class="line"># 如果分数大于5分，则通过，否则失败</div><div class="line"># 需要更改为单独计分，即每一个.py运行一次pylint</div><div class="line"># 对分数进行四舍五入（因bash不能处理浮点数）</div><div class="line">k=`echo $score|awk &apos;&#123; printf(&quot;%.0f\n&quot;, $0); &#125;&apos;`</div><div class="line">if [[ $&#123;k&#125; -ge 5 ]]</div><div class="line">then</div><div class="line">	echo &quot;该代码通过&quot;</div><div class="line">else</div><div class="line">	echo &quot;该代码评分未通过&quot;</div><div class="line">	let flag=1</div><div class="line">fi</div><div class="line"></div><div class="line">fi</div><div class="line"></div><div class="line">#Python 文件结束</div><div class="line">#########################################################</div><div class="line"></div><div class="line"></div><div class="line"># 文件循环结束</div><div class="line">done</div><div class="line"></div><div class="line"># 移除临时生成的文件</div><div class="line">rm *</div><div class="line"># 判断标记是否为0</div><div class="line">if [[ $flag == 0 ]]</div><div class="line">then </div><div class="line">	echo &quot;代码全部通过，提交成功&quot;</div><div class="line">else</div><div class="line">	echo &quot;有代码未通过，提交失败&quot;</div><div class="line">	exit 1</div><div class="line">fi</div><div class="line"></div><div class="line">exit 0</div></pre></td></tr></table></figure>
<p>gitlab端的钩子脚本即部署完毕，可以进行代码质量管理了。</p>
<h4 id="2-3测试代码质量"><a href="#2-3测试代码质量" class="headerlink" title="2.3测试代码质量"></a>2.3测试代码质量</h4><p>下面我们进行代码质量的检测，首先将原始文件推送上去，检测代码质量。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins49.png" alt=""></p>
<p>我们设置的代码质量通过评分为5分，此次代码质量7.69分，代码通过，其中有三个变量命名方式不规范，我们暂时不修改。</p>
<p>然后我们在代码中加入一行引用未安装的第三方的库，而且不调用，推送上去。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">import</span> BaseHTTPServer</div><div class="line"><span class="keyword">import</span> tensorflow</div><div class="line">...</div></pre></td></tr></table></figure>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins50.png" alt=""></p>
<p>结果显示评分为3.57分，未通过，有两条新增错误，一条是无法引用该库，第二个是未使用该引用库。</p>
<p>至此，实现了代码的质量管理。</p>
<h3 id="3-Jenkins"><a href="#3-Jenkins" class="headerlink" title="3.Jenkins"></a>3.Jenkins</h3><h4 id="3-1准备工作"><a href="#3-1准备工作" class="headerlink" title="3.1准备工作"></a>3.1准备工作</h4><p>由于我们在持续部署中使用到了docker服务，所以我们需要在代码之中，新增加一个<code>dockerfile</code>的文件，用于将代码部署成docker镜像。</p>
<p><code>dockerfile</code>直接放置在代码的根目录中，跟随代码一起推送上gitlab远程代码仓库。</p>
<p>dockerfile写法</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设定镜像的官方运行环境</span></div><div class="line"><span class="keyword">FROM</span> python:<span class="number">2</span></div><div class="line"><span class="comment"># 设定docker内部工作环境为根目录下的app文件夹</span></div><div class="line"><span class="keyword">WORKDIR</span> /app</div><div class="line"><span class="comment"># 添加宿主机当前目录的所有文件进入docker</span></div><div class="line"><span class="keyword">ADD</span> . /app</div><div class="line"></div><div class="line"><span class="comment"># 由于没有需要import的包，空安装会报错，所以注释了</span></div><div class="line"><span class="comment">#COPY requirements.txt ./</span></div><div class="line"><span class="comment">#RUN pip install --no-cache-dir -r requirements.txt</span></div><div class="line"></div><div class="line"><span class="comment"># 暴露docker的3002端口</span></div><div class="line"><span class="keyword">EXPOSE</span> <span class="number">3002</span></div><div class="line"><span class="comment"># 运行命令</span></div><div class="line"><span class="keyword">CMD</span> ["python","./test.py"]</div></pre></td></tr></table></figure>
<h4 id="3-2-设置配置"><a href="#3-2-设置配置" class="headerlink" title="3.2 设置配置"></a>3.2 设置配置</h4><p>首先是gitlab配置，当配置了公钥ssh上gitlab之后，就可以直接连上gitlab了。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins51.png" alt=""></p>
<p>接着是触发器，选择的是每一分钟检查一次gitlab是否有更新。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins52.png" alt=""></p>
<p>接着就是构建部分，直接运行一个shell脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">set +e</div><div class="line">echo &apos;&gt;&gt;&gt; Get old container id&apos;</div><div class="line"></div><div class="line"># 查找正在运行的docker容器</div><div class="line">CID=$(/usr/local/bin/docker ps | grep &quot;test-python&quot; | awk &apos;&#123;print $1&#125;&apos;)</div><div class="line"># 获取使用“test-python”镜像的容器id</div><div class="line">echo $CID</div><div class="line"></div><div class="line"># 根据新的代码，构建新的docker</div><div class="line">/usr/local/bin/docker build -t test-python .</div><div class="line"></div><div class="line"># 停止旧的容器</div><div class="line">if [ &quot;$CID&quot; != &quot;&quot; ];then</div><div class="line">  /usr/local/bin/docker stop $CID</div><div class="line">  # 删除旧容器</div><div class="line">  /usr/local/bin/docker rm $CID</div><div class="line">fi</div><div class="line"></div><div class="line"># 启动新容器</div><div class="line">/usr/local/bin/docker run -p 3002:3002 -d test-python</div><div class="line"></div><div class="line"></div><div class="line"># 删除旧镜像</div></pre></td></tr></table></figure>
<p>这样就完成了jenkins的配置。</p>
<h4 id="3-3查看部署效果"><a href="#3-3查看部署效果" class="headerlink" title="3.3查看部署效果"></a>3.3查看部署效果</h4><p>我们通过在返回的html页面中新增内容，从而可以从前后对比知道部署是否成功</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins53.png" alt=""></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins54.png" alt=""></p>
<p>部署成功</p>
<p>Reference:</p>
<p>[1] <a href="http://www.jianshu.com/p/b524b151d35f" target="_blank" rel="external">Jenkins使用简易教程</a></p>
<p>[2] <a href="https://testerhome.com/topics/10003" target="_blank" rel="external">https://testerhome.com/topics/10003</a></p>
<p>[3] <a href="https://personal-notes.me/%E5%9F%BA%E4%BA%8E-jenkinsdocker-%E6%90%AD%E5%BB%BA%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E6%96%B9%E6%A1%88/" target="_blank" rel="external">https://personal-notes.me/%E5%9F%BA%E4%BA%8E-jenkinsdocker-%E6%90%AD%E5%BB%BA%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E6%96%B9%E6%A1%88/</a></p>
<p>[4] <a href="https://yq.aliyun.com/articles/80459" target="_blank" rel="external">https://yq.aliyun.com/articles/80459</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/24/jenkins/jenkins7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/24/jenkins/jenkins7/" itemprop="url">
                  Jenkins学习笔记7-Docker WebGUI管理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-24T00:00:00+08:00">
                2017-12-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-Docker-WebGUI管理"><a href="#1-Docker-WebGUI管理" class="headerlink" title="1. Docker WebGUI管理"></a>1. Docker WebGUI管理</h3><ol>
<li><p><a href="https://github.com/shipyard/shipyard" target="_blank" rel="external">shipyard</a>国产，但是20天前刚刚宣布停止更新</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins22.png" alt=""></p>
</li>
<li><p><a href="http://rancher.com/" target="_blank" rel="external">rancher</a> 硬性条件：需要一台linux服务器做主机，至少2G内存和20G硬盘，较少更新</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins23.png" alt=""></p>
</li>
<li><p><a href="https://github.com/kevana/ui-for-docker" target="_blank" rel="external">kevana</a>已停止更新</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins24.png" alt=""></p>
</li>
<li><p><a href="https://portainer.io/" target="_blank" rel="external">portainer</a>比较轻量，github显示更新及时</p>
</li>
</ol>
<p>此处选择了portainer。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins19.png" alt=""></p>
<h3 id="2-Portainer"><a href="#2-Portainer" class="headerlink" title="2.Portainer"></a>2.Portainer</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>根据<a href="https://www.portainer.io/install.html" target="_blank" rel="external">官方教程</a>，使用portainer也是非常方便，使用它的官方docker镜像即可。(注意使用的是本机的9000端口，如有需要请修改)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer</div><div class="line">`</div></pre></td></tr></table></figure>
<p><font color="red">注意：</font><code>-v /var/run/docker.sock:/var/run/docker.sock</code>命令只能适用于linux环境</p>
<p>当启动完成后，portainer即在本机9000端口服务，首次进入后我们需要进行管理人员的账户创建。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins46.jpg" alt=""></p>
<p>之后我们就需要选择进行管理的docker环境（本地/远程）</p>
<p>如果是远程的话，我们需要输入目标docker服务器的地址、端口等信息，同时需要确保目标端的docker开启了TCP端口暴露设置，详情参考docker官方文档。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins47.png" alt=""></p>
<p>如果是本地的话就简单很多，直接选择连接即可，但是要注意，由于本操作需要开启portainer的docker镜像时，使用<code>-v /var/run/docker.sock:/var/run/docker.sock</code>命令才可以，但是Windows系统下无法执行该命令，所以Windows系统无法连接本地的docker。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins48.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/23/jenkins/jenkins6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/23/jenkins/jenkins6/" itemprop="url">
                  Jenkins学习笔记6-搭建gitlabs仓库&Gtilab实现代码质量管理（提交到代码仓库前）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-23T00:00:00+08:00">
                2017-12-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-搭建gitlab仓库"><a href="#1-搭建gitlab仓库" class="headerlink" title="1. 搭建gitlab仓库"></a>1. 搭建gitlab仓库</h3><h5 id="1-1-安装前准备工作"><a href="#1-1-安装前准备工作" class="headerlink" title="1.1 安装前准备工作"></a>1.1 安装前准备工作</h5><p>由于需要实现代码仓库的质量管理操作，所以我们需要搭建一个gitlab的仓库。</p>
<blockquote>
<p>GitLab是一个利用 <code>Ruby on Rails</code> 开发的开源应用程序，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。 </p>
<p>　　GitLab拥有与Github类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。</p>
</blockquote>
<p>在<a href="http://pirrla.cn/2017/12/21/jenkins/jenkins4/" target="_blank" rel="external">之前的教程</a>里，我们已经装好了docker，现在有了docker，所以搭建运行环境都比较方便，我们这里直接使用docker进行gitlab的搭建。</p>
<p>使用以下命令拉取所需要的docker镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker pull sameersbn/redis</div><div class="line">docker pull sameersbn/postgresql</div><div class="line">docker pull sameersbn/gitlab</div></pre></td></tr></table></figure>
<p>这里由于docker的官方镜像服务器在国外，所以访问速度比较慢。我们可以选择使用阿里云的镜像服务器进行加速。</p>
<p><a href="http://www.cnblogs.com/anliven/p/6218741.html" target="_blank" rel="external">http://www.cnblogs.com/anliven/p/6218741.html</a></p>
<h5 id="1-2-PostgreSQL介绍"><a href="#1-2-PostgreSQL介绍" class="headerlink" title="1.2 PostgreSQL介绍"></a>1.2 PostgreSQL介绍</h5><p>docker运行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker run --name postgresql -d \</div><div class="line">-e &apos;DB_NAME=gitlabhq_production&apos; \</div><div class="line">-e &apos;DB_USER=gitlab&apos; \</div><div class="line">-e &apos;DB_PASS=password&apos; \</div><div class="line">-e &apos;DB_EXTENSION=pg_trgm&apos; \</div><div class="line">-v /Users/alan/postgresql/data:/var/lib/postgresql \</div><div class="line">sameersbn/postgresql</div></pre></td></tr></table></figure>
<h5 id="1-3-Redis介绍"><a href="#1-3-Redis介绍" class="headerlink" title="1.3 Redis介绍"></a>1.3 Redis介绍</h5><p>docker运行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker run --name redis -d \</div><div class="line">-v /Users/alan/redis/data:/var/lib/redis \</div><div class="line">sameersbn/redis</div></pre></td></tr></table></figure>
<h5 id="1-4-搭建Gitlab"><a href="#1-4-搭建Gitlab" class="headerlink" title="1.4 搭建Gitlab"></a>1.4 搭建Gitlab</h5><p>当我们将PostgreSQL和redis跑起来之后，我们就可以进行gitlab的启动了。</p>
<p>docker运行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">docker run --name gitlab -d \</div><div class="line">--link postgresql:postgresql --link redis:redisio \</div><div class="line">-p 10022:22 -p 10080:80 \</div><div class="line">-e &apos;GITLAB_PORT=10080&apos; \</div><div class="line">-e &apos;GITLAB_SSH_PORT=10022&apos; \</div><div class="line">-e &apos;GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alpha-numeric-string&apos; \</div><div class="line">-e &apos;GITLAB_SECRETS_SECRET_KEY_BASE=long-and-random-alpha-numeric-string&apos; \</div><div class="line">-e &apos;GITLAB_SECRETS_OTP_KEY_BASE=long-and-random-alpha-numeric-string&apos; \</div><div class="line">-e &apos;GITLAB_HOST=服务器地址&apos; \</div><div class="line">-e &apos;GITLAB_EMAIL=邮箱地址&apos; \</div><div class="line">-e &apos;SMTP_ENABLED=true&apos; \</div><div class="line">-e &apos;SMTP_DOMAIN=www.sina.com&apos; \</div><div class="line">-e &apos;SMTP_HOST=smtp.sina.com&apos; \</div><div class="line">-e &apos;SMTP_STARTTLS=false&apos;  \</div><div class="line">-e &apos;SMTP_USER=邮箱地址&apos; \</div><div class="line">-e &apos;SMTP_PASS=邮箱密码&apos; \</div><div class="line">-e &apos;SMTP_AUTHENTICATION=login&apos; \</div><div class="line">-e &apos;GITLAB_BACKUP_SCHEDULE=daily&apos; \</div><div class="line">-e &apos;GITLAB_BACKUP_TIME=10:30&apos; \</div><div class="line">-v /home/root/opt/gitlab/data:/home/git/data \</div><div class="line">sameersbn/gitlab</div></pre></td></tr></table></figure>
<h5 id="1-5gitlab配置"><a href="#1-5gitlab配置" class="headerlink" title="1.5gitlab配置"></a>1.5gitlab配置</h5><p>当我们把gitlab运行起来之后，就可以访问默认的10080端口访问gitlab了。</p>
<font color="red">注意到可能初次访问有时会出现502错误，多试几次即可</font>

<p>当初次进入gitlab的页面时，需要重置管理员密码，然后跳转到登录界面。</p>
<p>默认用户名是root，密码为刚刚设置的密码。</p>
<p>登录完成之后就可以进入gitlab页面，具体使用跟github网站类似。</p>
<p>首先需要将本机的公钥输入到设置当中进行身份验证。</p>
<p>右上角找到<strong>settings</strong></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins26.png" alt=""></p>
<p>左侧找到<strong>SSH Keys</strong></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins27.png" alt=""></p>
<p>将本机的公钥填入即可，生成公钥可参考<a href="http://blog.csdn.net/qaz13177_58_/article/details/27544177" target="_blank" rel="external">如何生成ssh公钥</a></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins28.png" alt=""></p>
<p>现在即可如github一般使用gitlab了，可参考我的<a href="http://pirrla.cn/2017/03/16/other/GitTutorial_ByLiaoxuefeng/" target="_blank" rel="external">GIT学习笔记</a>，除了有一点不同</p>
<p>在github时，我们对github的访问是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git@github.com:alanhuangym/learngit.git</div></pre></td></tr></table></figure>
<p>现在使用gitlab我们使用ssh（10022端口）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh://git@localhost:10022/root/test.git</div></pre></td></tr></table></figure>
<p>当然也可以使用http连接（10080端口）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:10080/root/test.git</div></pre></td></tr></table></figure>
<h3 id="2-搭建基于git的代码质量管理"><a href="#2-搭建基于git的代码质量管理" class="headerlink" title="2.搭建基于git的代码质量管理"></a>2.搭建基于git的代码质量管理</h3><p>对于git，我们主要使用的是git hook对git进行代码质量管理。</p>
<p>代码质量管理不仅仅是指希望对代码可以执行，没有语法错误，我们更希望能实现例如代码注释率、代码重复率等高级指标，从而提高代码仓库的代码质量的目的，避免低质量、错误的代码入库。</p>
<blockquote>
<p>Git 钩子是在 Git 仓库中特定事件发生时自动运行的脚本。它可以让你自定义 Git 内部的行为，在开发周期中的关键点触发自定义的行为。</p>
<p>Git 钩子最常见的使用场景包括推行提交规范，根据仓库状态改变项目环境，和接入持续集成工作流。但是，因为脚本可以完全定制，你可以用 Git 钩子来自动化或者优化你开发工作流中任意部分。</p>
</blockquote>
<p>我们知道，git有两个仓库，一个是本地仓库，一个是远程仓库。所以对git的代码质量管理也有两个层面，一个是本地层面的<strong>Client-Side Hooks</strong>，另一个则是服务器层面的<strong>Server-Side Hooks</strong>。</p>
<h5 id="2-1-本地仓库管理"><a href="#2-1-本地仓库管理" class="headerlink" title="2.1 本地仓库管理"></a>2.1 本地仓库管理</h5><p>不论使用的是gitlab或者github，都有本地仓库hook管理。</p>
<p>在每一个git的项目中，都有一个<code>.git</code>隐藏文件夹，进入到里面的<code>hook</code>文件夹就可以看到一些已经预设好的hook脚本。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins29.png" alt=""></p>
<p>他们都带着<code>.sample</code>的后缀，证明他们是供我们参考的，拓展名防止它们默认被执行，如果希望执行这些hook，可以将<code>.sample</code>后缀去除。</p>
<p>这里钩子的脚本语言没有限制，一般的shell，ruby，python都可以。</p>
<p><strong>命名方式</strong>是决定他们在Git的哪一步被执行，所以命名方式需要注意，例如<code>pre-commit</code>钩子就是在用户进行commit操作的时候，在进行commit操作之前运行，详细的每个钩子的执行位置可以查看<a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks" target="_blank" rel="external">官方文档</a>，这里介绍一些比较实用的。</p>
<ul>
<li><code>pre-commit</code>是我们希望实现的代码质量管理的一个好钩子，它在用户在进行<code>git commit -m &quot;注释&quot;</code>提交修改到本地仓库时执行，在提交操作之前执行脚本，如果脚本没有通过，则不会执行提交修改操作，返回错误。</li>
</ul>
<p>这样的话我们就可以通过<code>pre-commit</code>钩子实现代码质量管理了，在<code>pre-commit</code>中写入代码质量管理的脚本，当质量过关时，返回<code>0</code>，即脚本已通过，可以执行<code>commit</code>操作，当质量不过关时，返回<code>非0数值</code>，此时脚本未通过，<code>commit</code>操作未成功，即实现了阻止错误、低质量代码进入代码库的操作。</p>
<p><font color="red">但是</font>我们需要注意到，<code>.git</code>文件是不会提交到远程仓库的，所以<code>pre-commit</code>脚本是不能同步到所有的协作者<code>.git</code>文件夹中的。</p>
<p>即是<code>pre-commit</code>脚本的作用域只在本机，且不受服务器控制（可以被本机删除而不执行）。所以，如果希望通过<code>pre-commit</code>进行版本质量管理，只能将脚本放在<code>.git</code>文件夹外，提交到远程仓库，同时需要复制文件进每一个协作者的<code>.git/hook</code>文件夹中。这样是一种<strong>鼓励形式</strong>的代码质量管理，可行性不高。</p>
<h5 id="2-2-远程仓库管理（重点）"><a href="#2-2-远程仓库管理（重点）" class="headerlink" title="2.2 远程仓库管理（重点）"></a>2.2 远程仓库管理（重点）</h5><p>由于本地仓库的钩子不能实现我们希望的效果，所以我们选择在服务端进行钩子脚本构建。在服务器端构建钩子有以下好处：</p>
<ul>
<li>无法被本地修改，强制进行质量管理</li>
<li>可以统一在服务器进行对质量管理阈值的修改</li>
</ul>
<p>同时也有部分的缺点：</p>
<ul>
<li>没有一个通用的代码质量管理软件，只能对应每一个项目建立相对语言的代码质量管理</li>
</ul>
<h6 id="2-2-1-全局钩子"><a href="#2-2-1-全局钩子" class="headerlink" title="2.2.1 全局钩子"></a>2.2.1 全局钩子</h6><p>当使用docker构建gitlab时，远程仓库的脚本存在于docker容器内的<code>/home/git/gitlab-shell/hooks</code>路径当中。</p>
<p>进入docker容器内可以使用命令<code>docker exec -it 容器ID /bin/bash</code></p>
<p>这个路径下存放有三个钩子，分别是<code>pre-receive</code>，<code>post-receive</code>和<code>update</code>。</p>
<p>这三个是<font color="red">gitlab全局的钩子脚本</font>，就是这三个脚本对gitlab内的所有项目启用。他们三个的运行顺序如下</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins58.png" alt=""></p>
<p>他们各自代表的步骤是：</p>
<ul>
<li><p>pre-receive</p>
<p>在服务器收到用户推送的代码之前，进行操作</p>
</li>
</ul>
<ul>
<li><p>update</p>
<p>服务器已经收到代码之后，对分支进行更新的操作，如果有多个分支则会运行多次update，且update操作之间<font color="red">相互独立</font>，失败不影响其他</p>
</li>
</ul>
<ul>
<li><p>post-receive</p>
<p>在服务器已经更新完服务器端的代码之后的操作，一般是对客户返回信息</p>
</li>
</ul>
<p>所以如果我们需要对代码进行质量管理，应该选择的是<code>update</code>钩子。</p>
<h6 id="2-2-2-项目钩子"><a href="#2-2-2-项目钩子" class="headerlink" title="2.2.2 项目钩子"></a>2.2.2 项目钩子</h6><p>但是如果我们想用这三个全局钩子对所有的项目进行质量管理是不科学的，首先是因为没有一个通用的全代码质量管理工具，所以不能对全局使用同一个脚本，需要对不同的编程语言使用不同的脚本，其次，每一个项目可能会有特殊的需求，使用全局脚本不现实。所以我们需要找到每个脚本各自的<code>pre-receive</code>钩子。</p>
<p>每一个项目各自的钩子可以在路径<code>/home/git/data/repositories/用户名/项目名.git</code>或者<code>/home/git/repositories/&lt;group&gt;/&lt;project&gt;.git</code>路径中找到。</p>
<p>文件夹当中有一个<code>hooks</code>文件夹，<font color="red">但是</font>这个是一个超链接，跳转到的是全局钩子的地址<code>/home/git/gitlab-shell/hooks</code>。</p>
<p>我们就可以知道，项目是通过这个超链接去调用全局脚本的，所以如果我们希望项目能调用自己的脚本，那么我们可以创建一个同名的<code>hooks</code>文件夹替代，从而实现项目的个性化处理。</p>
<p><font color="red">不过需要注意的是</font>，当我们使用自定义的脚本的时候 ，如果将全局脚本当做模板进行改写的时候，全局脚本内有一些关联路径的语句，例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">require_relative &apos;../lib/gitlab_custom_hook</div></pre></td></tr></table></figure>
<p>这里是定义了全局脚本的<font color="red">相对地址</font>，所以我们需要更改为<font color="red">绝对地址</font>，例如改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">require_relative &apos;/home/git/gitlab-shell/lib/gitlab_custom_hook</div></pre></td></tr></table></figure>
<p>为了实现我们的项目钩子的编写，查看<a href="https://docs.gitlab.com/ee/administration/custom_hooks.html" target="_blank" rel="external">官方文档</a>，我们了解到自定义钩子的写法是在<code>/home/git/repositories/&lt;group&gt;/&lt;project&gt;.git</code>文件夹内创建一个名为<code>custome_hooks</code>的文件夹，然后再文件夹内放置脚本，放置脚本的方法也有两种：</p>
<ul>
<li><p>直接创建同名的<font color="red">可执行</font>脚本</p>
<p>例如直接创建一个名为<code>pre-receive</code>的<font color="red">可执行</font>脚本</p>
</li>
</ul>
<ul>
<li><p>创建同名后缀为<code>.d</code>的文件夹，文件夹内放置脚本（命名随意）</p>
<p>例如创建一个<code>pre-receive.d</code>文件夹，在文件夹内放入一些<font color="red">可执行</font>脚本，则会按照命名顺序，顺序执行</p>
</li>
</ul>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins35.png" alt=""></p>
<p><font color="red">**</font>这里我们遇到的可执行脚本的问题，可以通过命令行解决，只需要一行命令<code>chmod +x 文件名</code>即可以将脚本变为可执行脚本</p>
<p><font color="red">需要注意的是</font>，如果没有将脚本变为可执行，那么脚本将不会在自定义钩子中生效。</p>
<p>我们的自定义钩子是在官方的脚本运行结束后运行的，但是因为自定义钩子的写法也有不同，所以运行自定义钩子的顺序也有所不同，通过实验（通过对所有脚本加上一个命令行输出查看），我们了解到顺序如下：</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins33.png" alt=""></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins34.png" alt=""></p>
<h3 id="3-钩子脚本编写"><a href="#3-钩子脚本编写" class="headerlink" title="3.钩子脚本编写"></a>3.钩子脚本编写</h3><p>当我们了解完全局钩子和自定义钩子的写法和执行顺序之后，我们就可以开始部署我们的代码质量检查钩子的编写了。由于没有一个统一的软件对全部代码进行统一的代码检测，所以我们将针对不同语言的项目进行不同的代码质量管理部署。</p>
<h5 id="3-1-服务器代码存放问题"><a href="#3-1-服务器代码存放问题" class="headerlink" title="3.1 服务器代码存放问题"></a>3.1 服务器代码存放问题</h5><p>首先，由于在gitlab上存储的是每一个项目的.git文件夹，即<font color="red">服务器端没有存放除.git文件夹内容外真实存在的代码</font>，数据文件只有.git文件夹的objects文件（文件包含提交信息、项目树信息，代码信息、标签信息）。</p>
<p>所以如果我们希望在服务器端实现代码质量审查，那么我们就首先需要将代码从objects文件夹中提取出来，再进行代码质量审查。</p>
<h5 id="3-2-Git的数据存放原理"><a href="#3-2-Git的数据存放原理" class="headerlink" title="3.2 Git的数据存放原理"></a>3.2 Git的数据存放原理</h5><p>Git 存储数据内容的方式──为每份内容生成一个文件，取得该内容与头信息的 SHA-1 校验和，创建以该校验和前两个字符为名称的子目录，并以 (校验和) 剩下 38 个字符为文件命名 (保存至子目录下)。每当文件有改动之后，SHA-1值都会变动，所以我们可以通过SHA-1值找到不同版本的代码。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins37.jpg" alt=""></p>
<p>对于SHA-1数据类型的文件，我们主要使用<code>git cat-file</code>命令对文件进行解析读取。</p>
<p>Git中有四种基本的对象类型，这四种基本类型组成了Git更高级的数据结构。</p>
<ul>
<li><p>blob</p>
<p>每一个blob文件储存着一个（版本的）文件，blob文件只包含文件的数据，而忽略文件的其他元数据，如名字、路径、格式等。</p>
</li>
</ul>
<ul>
<li><p>tree</p>
<p>tree代表了<font color="red">一个目录</font>的信息，包含了该目录下的blob文件和相应的元文件信息和子目录（对应的子tree）。git对项目的管理就是使用嵌套的tree结构对文件进行存储。</p>
</li>
<li><p>commit</p>
<p>每一个commit提交记录都记录着该次提交的一些内容，例如该次提交后的tree的信息，父commit的信息，作者和提交时间的信息，提交日志。</p>
</li>
<li><p>tag</p>
<p>tag通常用于为commit命名一个易于记忆和分辨的名字。</p>
</li>
</ul>
<p>下面用一个例子简单解释一下以上的数据类型</p>
<p>在根目录的tree对象里我们可以看到，这里有两个文件 README和Rakefile都是blob对象，lib是一个子目录，所以是tree对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git cat-file -p master^&#123;tree&#125;</div><div class="line">100644 blob a906cb2a4a904a152e80877d4088654daad0c859      README</div><div class="line">100644 blob 8f94139338f9404f26296befa88755fc2598c289      Rakefile</div><div class="line">040000 tree 99f1a6d12cb4b6f19c8655fca46c3ecf317074e0      lib</div></pre></td></tr></table></figure>
<p>再进入子树lib的查看，可以看到有一个simplegit.rb的rubu文件的blob对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git cat-file -p 99f1a6d12cb4b6f19c8655fca46c3ecf317074e0</div><div class="line">100644 blob 47c6340d6459e05787f644c2447d2595f5d3a54b      simplegit.rb</div></pre></td></tr></table></figure>
<p>结构图如下</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins38.png" alt=""></p>
<h5 id="3-3-通用代码存放脚本"><a href="#3-3-通用代码存放脚本" class="headerlink" title="3.3 通用代码存放脚本"></a>3.3 通用代码存放脚本</h5><p>由于在服务器端没有存放真实的代码，所以我们需要在receive到用户push上来的commit文件之后，对文件进行解析，并将代码读取保存在服务器的临时文件夹中。</p>
<p>所以我们对钩子中的update进行编写，脚本使用的是shell脚本，主要就是解析提交文件，然后将<font color="red">有改动或新增</font>的代码放置入服务器的临时文件夹中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="comment"># 提交分支的名字</span></div><div class="line">ref_name=<span class="variable">$1</span></div><div class="line"><span class="comment"># 上一个commit的ID</span></div><div class="line">old_value=<span class="variable">$2</span></div><div class="line"><span class="comment"># 现在这个commit的ID</span></div><div class="line">new_value=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="comment"># 共有四种状态</span></div><div class="line"><span class="comment"># M-修改，A-新增，D-删除，RXXX-重命名 XXX是指重命名前后代码相似度</span></div><div class="line"><span class="comment"># 所以这里选择修改和新增和重命名的进行代码审查</span></div><div class="line"><span class="comment"># （因为重命名会覆盖掉D和M的状态</span></div><div class="line">new_and_modify=`git diff <span class="variable">$old_value</span> <span class="variable">$new_value</span> --raw | grep <span class="string">"\sM\s\|\sA\s"</span> | awk <span class="string">'&#123;print $4"\t"$6&#125;'</span> |  uniq`</div><div class="line">rename=`git diff <span class="variable">$old_value</span> <span class="variable">$new_value</span> --raw | grep <span class="string">"\sR.*\s"</span> | awk <span class="string">'&#123;print $4"\t"$7&#125;'</span> |  uniq`</div><div class="line"><span class="comment"># 检查文件夹和文件的名字是否有空格</span></div><div class="line"><span class="comment"># 有空格则直接提交失败</span></div><div class="line">count=`git show <span class="variable">$new_value</span> --name-only | grep <span class="string">"\s"</span> -c`</div><div class="line"><span class="keyword">if</span> [[ <span class="variable">$count</span> <span class="_">-gt</span> 4 ]]</div><div class="line"><span class="keyword">then</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"文件/文件夹 名字包含空格，提交失败"</span></div><div class="line">	<span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># 将字符串变为数组</span></div><div class="line">new_and_modify_array=(<span class="variable">$new_and_modify</span>)</div><div class="line">rename_array=(<span class="variable">$rename</span>)</div><div class="line"></div><div class="line">collect_array=(<span class="variable">$&#123;new_and_modify_array[@]&#125;</span> <span class="variable">$&#123;rename_array[@]&#125;</span>)</div><div class="line"></div><div class="line"><span class="comment"># n用于遍历数组</span></div><div class="line">n=0</div><div class="line"><span class="comment"># 遍历数组，提取出需要代码质量管理的文件的blob id和原本的文件名</span></div><div class="line"><span class="keyword">while</span> [ <span class="variable">$n</span> <span class="_">-lt</span> <span class="variable">$&#123;#collect_array[@]&#125;</span> ]</div><div class="line"><span class="keyword">do</span></div><div class="line">	<span class="comment"># blob id 用于提取代码</span></div><div class="line">	blob_id=<span class="variable">$&#123;collect_array[$n]:0:7&#125;</span></div><div class="line">	<span class="comment"># 文件名，由于带有路径，所以将文件名中的/斜杠替换为_下划线</span></div><div class="line">	f_name=<span class="variable">$&#123;collect_array[$&#123;n&#125;</span>+1]////_&#125;</div><div class="line">	<span class="comment"># 将代码保存到临时文件夹中</span></div><div class="line">	git show <span class="variable">$blob_id</span> &gt; temp_files/code_<span class="variable">$&#123;f_name&#125;</span></div><div class="line">	<span class="comment"># n自增，用于遍历</span></div><div class="line">	<span class="built_in">let</span> n+=2</div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="comment"># 该标记用于识别是否有代码没用通过，全部通过则为0，只要有一个代码没通过就为1</span></div><div class="line">flag=0</div><div class="line"></div><div class="line"><span class="comment"># 转换工作路径到临时文件夹</span></div><div class="line"><span class="built_in">cd</span> temp_files</div><div class="line"><span class="comment"># 获取临时文件夹里的文件</span></div><div class="line">files=`ls`</div><div class="line"><span class="comment"># 如果临时文件夹里没有内容，则证明没有进行代码修改</span></div><div class="line"><span class="comment"># 不需要进行代码管理，返回0</span></div><div class="line"><span class="keyword">if</span> [[ <span class="variable">$files</span> == <span class="string">""</span> ]]</div><div class="line"><span class="keyword">then</span> </div><div class="line">	<span class="built_in">exit</span> 0</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># 将文件转换成数组，遍历数组，对每一个文件分别进行代码质量管理操作</span></div><div class="line">files_array=(<span class="variable">$files</span>)</div><div class="line"><span class="comment"># m用于遍历数组</span></div><div class="line">m=0</div><div class="line">files_count=<span class="variable">$&#123;#files_array[@]&#125;</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"此次提交共有 <span class="variable">$files_count</span> 个文件进行过修改/新增/重命名"</span></div><div class="line"></div><div class="line"><span class="keyword">while</span> [ <span class="variable">$m</span> <span class="_">-lt</span> <span class="variable">$&#123;#files_array[@]&#125;</span> ]</div><div class="line"><span class="keyword">do</span></div><div class="line">	<span class="comment"># 文件名</span></div><div class="line">	file_name=<span class="variable">$&#123;files_array[$m]&#125;</span></div><div class="line">	<span class="built_in">let</span> m+=1</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#########################################################</span></div><div class="line"><span class="comment">#此处，不同语言应对不同的代码质量管理程序</span></div><div class="line"><span class="comment">#主要操作是 `操作语句 $file_name` </span></div><div class="line"><span class="comment">#例如python语言使用的是pylint，那么语句就是`pylint $file_name`</span></div><div class="line"><span class="comment">#主要通过设定flag的值操作代码是否通过</span></div><div class="line"><span class="comment">#########################################################</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 文件循环结束</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="comment"># 移除临时生成的文件</span></div><div class="line">rm *</div><div class="line"><span class="comment"># 判断标记是否为0</span></div><div class="line"><span class="keyword">if</span> [[ <span class="variable">$flag</span> == 0 ]]</div><div class="line"><span class="keyword">then</span> </div><div class="line">	<span class="built_in">echo</span> <span class="string">"代码全部通过，提交成功"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"有代码未通过，提交失败"</span></div><div class="line">	<span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">exit</span> 0</div></pre></td></tr></table></figure>
<h5 id="3-4-Python代码质量管理"><a href="#3-4-Python代码质量管理" class="headerlink" title="3.4 Python代码质量管理"></a>3.4 Python代码质量管理</h5><p>首先需要在gitlab环境中，安装<a href="https://www.pylint.org/" target="_blank" rel="external">pylint</a></p>
<p>进入gitlab服务器docker内部<code>docker exec -it 容器ID /bin/bash</code></p>
<p>首先下载python包下载工具pip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://bootstrap.pypa.io/get-pip.py</div><div class="line">python get-pip.py</div></pre></td></tr></table></figure>
<p>然后使用pip下载pylint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install pylint</div></pre></td></tr></table></figure>
<p>或者在构建gitlab服务器时，先将代码输入进去，从而构建一个带有pylint的gitlab服务，dockerfile如下，根据dockerfile构建镜像</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sameersbn/gitlab</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /home</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> wget https://bootstrap.pypa.io/get-pip.py</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> python get-pip.py</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> pip install pylint</span></div></pre></td></tr></table></figure>
<p>脚本如下，pylint会返回一个报告供我们进行修改，然后有一个评分，我们可以根据评分进行阈值设定，例如这里这里设定的是四舍五入之后的评分大于等于5分则通过审查，可以提交成功，flag值为0。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">#########################################################</div><div class="line">#Python 文件</div><div class="line">if [[ $file_name = *.py ]]</div><div class="line">then</div><div class="line"></div><div class="line"># 运行pylint脚本，对代码进行审查</div><div class="line"># 将报告输出在临时文件夹的report.txt中</div><div class="line">pylint $file_name  &gt; report.txt</div><div class="line"></div><div class="line"># 检测是否代码有语法错误，如果有语法错误直接退出</div><div class="line"># （因为有语法错误的话没有评分，无法与阈值比较</div><div class="line">error=`cat report.txt | grep &quot;syntax-error&quot;`</div><div class="line">if [[ $error != &quot;&quot; ]]</div><div class="line">then</div><div class="line">	echo $file_name &quot;有语法错误，提交失败&quot;</div><div class="line">	exit 1</div><div class="line">fi</div><div class="line"></div><div class="line"># 获取评分的语句</div><div class="line">score_senten=`cat report.txt | grep &quot;rated&quot; | awk &apos;&#123;print $7&#125;&apos;`</div><div class="line"></div><div class="line"># 从语句中提取分数</div><div class="line">if [[ &quot;$score_senten&quot; =~ (.*)/10 ]] </div><div class="line">then</div><div class="line">	score=&quot;$&#123;BASH_REMATCH[1]&#125;&quot;</div><div class="line">else</div><div class="line">	score=0</div><div class="line">fi</div><div class="line"></div><div class="line">echo $file_name 程序得分为 $score_senten</div><div class="line">echo 程序分析报告:</div><div class="line">cat report.txt</div><div class="line"></div><div class="line"># 如果分数大于5分，则通过，否则失败</div><div class="line"># 需要更改为单独计分，即每一个.py运行一次pylint</div><div class="line"># 对分数进行四舍五入（因bash不能处理浮点数）</div><div class="line">k=`echo $score|awk &apos;&#123; printf(&quot;%.0f\n&quot;, $0); &#125;&apos;`</div><div class="line">if [[ $&#123;k&#125; -ge 5 ]]</div><div class="line">then</div><div class="line">	echo &quot;该代码通过&quot;</div><div class="line">else</div><div class="line">	echo &quot;该代码评分未通过&quot;</div><div class="line">	let flag=1</div><div class="line">fi</div><div class="line"></div><div class="line">fi</div><div class="line"></div><div class="line">#Python 文件结束</div><div class="line">#########################################################</div></pre></td></tr></table></figure>
<h5 id="3-5-Javascript-代码"><a href="#3-5-Javascript-代码" class="headerlink" title="3.5 Javascript 代码"></a>3.5 Javascript 代码</h5><p>References:</p>
<p>[1] <a href="http://blog.csdn.net/abcdocker/article/category/6638595" target="_blank" rel="external">持续集成 by www.abcdocker.com</a></p>
<p>[2] <a href="https://www.jianshu.com/p/060e7223e211?open_source=weibo_search" target="_blank" rel="external">使用docker搭建gitlab初体验+数据备份</a></p>
<p>[3] <a href="https://www.jianshu.com/p/5531a21afa68" target="_blank" rel="external">Gitlab 服务器端 custom hook 配置</a></p>
<p>[4] <a href="https://github.com/geeeeeeeeek/git-recipes/wiki/5.4-Git-%E9%92%A9%E5%AD%90%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BD%A0%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81" target="_blank" rel="external">Git 钩子</a></p>
<p>[5] <a href="https://docs.gitlab.com/ee/administration/custom_hooks.html" target="_blank" rel="external">Custom Git Hooks </a></p>
<p>[6] <a href="https://www.zhihu.com/question/65604891/answer/232935144" target="_blank" rel="external">https://www.zhihu.com/question/65604891/answer/232935144</a></p>
<p>[7] <a href="https://git-scm.com/book/zh/v2/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Git-%E5%AF%B9%E8%B1%A1" target="_blank" rel="external">https://git-scm.com/book/zh/v2/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Git-%E5%AF%B9%E8%B1%A1</a></p>
<p>[8] <a href="http://blog.jobbole.com/26209/" target="_blank" rel="external">http://blog.jobbole.com/26209/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/22/jenkins/jenkins5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/22/jenkins/jenkins5/" itemprop="url">
                  Jenkins学习笔记5-官方用法pipeline&开启BlueOcean GUI(可选)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-22T00:00:00+08:00">
                2017-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>官方的文档是在描述另一种jenkins的用法pipeline。pipeline有其特有的语句，我们以下以一个node.js和npm的例子来进行说明。</p>
<h3 id="1-Pipeline"><a href="#1-Pipeline" class="headerlink" title="1.Pipeline"></a>1.Pipeline</h3><p>pipeline其实就是使用jenkins定义好的语法，编写你的流程，不再是使用图形界面去进行流程构建。<a href="https://jenkins.io/doc/pipeline/tour/hello-world/" target="_blank" rel="external">教程地址</a></p>
<h4 id="1-1-多种语言"><a href="#1-1-多种语言" class="headerlink" title="1.1 多种语言"></a>1.1 多种语言</h4><p>可以使用多种语言来进行pipeline编写，包括Java/Node.js/Ruby/Python/PHP。</p>
<p>基础的结构式是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">pipeline &#123;</div><div class="line">    agent &#123; docker &apos;python:3.5.1&apos; &#125;</div><div class="line">    stages &#123;</div><div class="line">        stage(&apos;build&apos;) &#123;</div><div class="line">            steps &#123;</div><div class="line">                sh &apos;python --version&apos;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="agent"><a href="#agent" class="headerlink" title="agent"></a>agent</h4><p>agent是指该pipeline在特定的环境下进行执行。</p>
<p>除了在顶部进行定义之外，在每一步也可以自定义。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">pipeline &#123;</div><div class="line">    agent none</div><div class="line">    stages &#123;</div><div class="line">        stage(&apos;Example Build&apos;) &#123;</div><div class="line">            agent &#123; docker &apos;maven:3-alpine&apos; &#125;</div><div class="line">            steps &#123;</div><div class="line">                echo &apos;Hello, Maven&apos;</div><div class="line">                sh &apos;mvn --version&apos;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        stage(&apos;Example Test&apos;) &#123;</div><div class="line">            agent &#123; docker &apos;openjdk:8-jre&apos; &#125;</div><div class="line">            steps &#123;</div><div class="line">                echo &apos;Hello, JDK&apos;</div><div class="line">                sh &apos;java -version&apos;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="stages-stage"><a href="#stages-stage" class="headerlink" title="stages/stage"></a>stages/stage</h4><p>表示多个或一个步骤，大部分操作都在该序列中执行。</p>
<h4 id="steps"><a href="#steps" class="headerlink" title="steps"></a>steps</h4><p>一条或多条命令在stage中执行</p>
<h3 id="2-Blue-Ocean"><a href="#2-Blue-Ocean" class="headerlink" title="2. Blue Ocean"></a>2. Blue Ocean</h3><p>Blue Ocean首先是对Jenkins的运行检视页面进行UI替换，替换成更美观的界面。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins55.png" alt=""></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins56.png" alt=""></p>
<p>其次，blue ocean赋予了构建jenkins pipeline一个图形化界面，可以通过简单的点击操作即可以构建jenkins pipeline流程。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins57.png" alt=""></p>
<p>当使用docker运行jenkins时，通常会已经安装好blue ocean的插件，而当使用war包进行jenkins运行时，blue ocean需要自行安装。</p>
<p>blue ocean插件安装完成后，在左侧的控制栏上会有一个 <code>Open Blue Ocean</code>的按钮，点击即可以开启blue ocean页面。</p>
<p>Reference:</p>
<p>[1] <a href="http://www.jianshu.com/p/b524b151d35f" target="_blank" rel="external">Jenkins使用简易教程</a></p>
<p>[2] <a href="https://testerhome.com/topics/10003" target="_blank" rel="external">https://testerhome.com/topics/10003</a></p>
<p>[3] <a href="https://personal-notes.me/%E5%9F%BA%E4%BA%8E-jenkinsdocker-%E6%90%AD%E5%BB%BA%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E6%96%B9%E6%A1%88/" target="_blank" rel="external">https://personal-notes.me/%E5%9F%BA%E4%BA%8E-jenkinsdocker-%E6%90%AD%E5%BB%BA%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E6%96%B9%E6%A1%88/</a></p>
<p>[4] <a href="https://yq.aliyun.com/articles/80459" target="_blank" rel="external">https://yq.aliyun.com/articles/80459</a></p>
<p>[5] <a href="http://www.cnblogs.com/YatHo/p/7856556.html" target="_blank" rel="external">http://www.cnblogs.com/YatHo/p/7856556.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/21/jenkins/jenkins4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/21/jenkins/jenkins4/" itemprop="url">
                  Jenkins学习笔记4-使用Docker对环境和代码打包
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-21T00:00:00+08:00">
                2017-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>当我们已经完成了了尝试重启Node.js服务之后，我们应该发现，远程的代码仓库对于node.js的代码，是没有保存Node Modules的。这个文件夹包含的都是node.js需要的第三方的环境库等的包，所以不适合放入远程仓库里。</p>
<p>于是我们每次都需要执行一次<code>npm install</code>的操作，确保下载全部的包。但是这样的操作十分耗时耗力，所以我们考虑到使用docker对我们的基础环境进行打包，生成dockerfile和dockerimage，从而就不需要每次都对生产环境进行更新操作。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins11.png" alt=""></p>
<h3 id="1-docker简介"><a href="#1-docker简介" class="headerlink" title="1. docker简介"></a>1. docker简介</h3><p>安装docker就不介绍了，可以直接从<a href="https://www.docker.com" target="_blank" rel="external">官网</a>按照指引安装</p>
<h5 id="1-1-docker的一些基础概念"><a href="#1-1-docker的一些基础概念" class="headerlink" title="1.1 docker的一些基础概念"></a>1.1 docker的一些基础概念</h5><ul>
<li><strong>镜像（image）</strong>：相当于docker容器启动的母版，docker启动的都是从镜像延伸出来的容器，可以自己构建和存储在镜像仓库</li>
<li><strong>容器（container）</strong>：由单一服务构成的针对最基本功能实现的 <strong>服务（service）</strong>（比如Nginx），docker推荐的是一个容器一个服务</li>
</ul>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins18.png" alt=""></p>
<h5 id="1-2-docker基础操作"><a href="#1-2-docker基础操作" class="headerlink" title="1.2 docker基础操作"></a>1.2 docker基础操作</h5><p>docker的具体操作可以查看<a href="https://docs.docker.com/" target="_blank" rel="external">官方文档</a>或者命令行<code>docker —help</code>，这里介绍一些比较常用的</p>
<p><strong>容器生命周期管理</strong></p>
<ul>
<li><p><code>docker run -p 80:80 -v /data:/data -d nginx:latest</code></p>
<p>创建一个新的容器并运行一个命令，通常使用是<code>-p 80:80</code> 将宿主机的80端口与docker容器的80端口绑定，<code>-v /data:/data</code>将宿主机的文件路径与docker容器内部的文件相映射，通常用来存储容器的数据，从而达到增量更新和缓存的目的，<code>-d</code>是后台运行并返回新创建容器的id，<code>nginx:latest</code>是镜像名和标签</p>
</li>
<li><p><code>docker start</code> 启动一个或多少已经被停止的容器</p>
<p><code>docker stop</code> 停止一个运行中的容器</p>
<p><code>docker restart</code>重启容器</p>
</li>
<li><p><code>docker rm</code>移除一个容器，当容器停止之后不会消失，需要手动删除</p>
</li>
</ul>
<p><strong>容器操作</strong></p>
<ul>
<li><code>docker ps</code>查看当前正在运行的容器，<code>-a</code>可以查看所有容器包括未运行的</li>
<li><code>docker cp &lt;containerId&gt;:/file/path/within/container /host/path/target</code> 将容器内的文件拷贝到宿主机中</li>
</ul>
<p><strong>本地镜像管理</strong></p>
<ul>
<li><code>docker build -t 创建的镜像名称和标签 文件路径</code>使用文件路径的Dockerfile创建镜像，如果镜像名称和标签有重复的，则最新的镜像会使用该名称和标签，旧的镜像将变成\<none\>，在后述操作当中可以批量删除。</none\></li>
<li><code>docker rmi</code>移除镜像</li>
</ul>
<p><strong>镜像仓库</strong></p>
<ul>
<li><code>docker push</code></li>
<li><code>docker pull</code></li>
</ul>
<h5 id="1-3-dockerfile构建"><a href="#1-3-dockerfile构建" class="headerlink" title="1.3 dockerfile构建"></a>1.3 dockerfile构建</h5><p>docker可以直接使用官方的镜像，包含基础运行程序的环境，但如果希望创建新的镜像，可以使用dockerfile进行构建。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设定镜像的官方运行环境</span></div><div class="line"><span class="keyword">FROM</span> google/nodejs</div><div class="line"><span class="comment"># 设定docker内部工作环境为根目录下的app文件夹</span></div><div class="line"><span class="keyword">WORKDIR</span> /app</div><div class="line"><span class="comment"># 添加宿主机中的package.json文件进入docker内app文件夹</span></div><div class="line"><span class="keyword">ADD</span> package.json /app/</div><div class="line"><span class="comment"># 在docker内部运行npm install命令，根据需要安装第三方库</span></div><div class="line"><span class="keyword">RUN</span> npm install</div><div class="line"><span class="comment"># 添加宿主机当前目录的所有文件进入docker</span></div><div class="line"><span class="keyword">ADD</span> . /app</div><div class="line"><span class="comment"># 暴露docker的8000端口</span></div><div class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></div><div class="line"><span class="comment"># 不运行命令</span></div><div class="line"><span class="keyword">CMD</span> []</div><div class="line"><span class="comment"># 启动服务</span></div><div class="line"><span class="keyword">ENTRYPOINT</span> ["/nodejs/bin/npm", "start"]</div></pre></td></tr></table></figure>
<h5 id="1-4-docker-compose-与jenkins类似"><a href="#1-4-docker-compose-与jenkins类似" class="headerlink" title="1.4 docker compose 与jenkins类似"></a>1.4 docker compose 与jenkins类似</h5><h5 id="1-5-docker-私有仓库搭建"><a href="#1-5-docker-私有仓库搭建" class="headerlink" title="1.5 docker 私有仓库搭建"></a>1.5 docker 私有仓库搭建</h5><p>仓库的搭建也不难，只用使用官方的registry docker即可。</p>
<p>启动代码<code>sudo docker run -d -p 5000:5000 -v /data:/tmp/registry —restart=always --name</code></p>
<p>即在5000端口启动了一个仓库docker</p>
<font color="red">*</font>一般启动registryd docker会遇到https安全传输的问题。<br><br>一般当尝试向服务器push镜像时，会出现错误<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Forbidden. If this private registry supports only HTTP or HTTPS with an unknown CA certificate, please add –insecure-registry 10.0.0.26:5000 to the daemon’s arguments.</div></pre></td></tr></table></figure><br><br>解决这个问题的方法见<a href="http://stackoverflow.com/questions/26710153/remote-access-to-a-private-docker-registry" target="_blank" rel="external">StackOverflow</a><br>最快最简单的方法是将如下行添加到<code>/etc/default/docker</code>，然后重启Docker Daemon：<br><code>DOCKER_OPTS=&quot;--insecure-registry localhost:5000&quot;</code><br><br>##### 1.6 Swarm集群拓展<br><br>##### 1.7 小问题：<br><br>- 当docker启动后，希望添加docker与宿主机的端口映射<br><br>  docker容器的操作变换很方便快捷，同时消耗比较少，所以如果希望更改端口映射，不建议手工添加，最好还是重新开启一个容器，使用docker官方的用法<code>-p 5000:5000</code><br><br>  如果容器内有工作内容需要保存，可以commit一个docker image保存数据，然后再启动一个新的容器<br><br><br>- docker容器启动的后的进入方法<br><br>  docker还是提倡一个容器一个进程的理念，但是有时还是需要进入docker容器中，进行一些配置，所以我们需要一个方法进入已经启动的docker容器内，同时需要一个终端进行交互<br><br>  - docker attach<br>  - docker 第三方工具(nsenter、nsinit)<br>  - docker exec<font color="“red”">（推荐）</font>

<h5 id="1-8-Docker镜像仓库国内加速"><a href="#1-8-Docker镜像仓库国内加速" class="headerlink" title="1.8 Docker镜像仓库国内加速"></a>1.8 Docker镜像仓库国内加速</h5><p><a href="http://www.cnblogs.com/anliven/p/6218741.html" target="_blank" rel="external">http://www.cnblogs.com/anliven/p/6218741.html</a></p>
<h3 id="2-APACHE服务器"><a href="#2-APACHE服务器" class="headerlink" title="2.APACHE服务器"></a><del>2.APACHE服务器</del></h3><h3 id="3-Jenkins持续化集成"><a href="#3-Jenkins持续化集成" class="headerlink" title="3.Jenkins持续化集成"></a>3.Jenkins持续化集成</h3><p>介绍完docker和apache，我们希望能够通过jenkins进行一个集成，能够自动化实现在docker容器中的apache服务器的重启操作。</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins16.png" alt=""></p>
<h5 id="3-1-在jenkins中使用docker有两种方法"><a href="#3-1-在jenkins中使用docker有两种方法" class="headerlink" title="3.1 在jenkins中使用docker有两种方法"></a>3.1 在jenkins中使用docker有两种方法</h5><ol>
<li>为jenkins添加用户权限，直接在命令行执行</li>
<li>使用docker build step plugin 插件进行docker操作</li>
</ol>
<p>因为插件操作比较麻烦，所以我们选择给jenkins添加用户权限，从而直接在命令行中编写脚本</p>
<p><font color="red">*</font>为macos添加jenkins用户权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 使用id查看自己的群组和用户名称</div><div class="line">$ id</div><div class="line">uid=501(alan) gid=20(staff)  ...</div><div class="line"></div><div class="line"># 获取之后，先停止jenkins服务</div><div class="line">$ sudo launchctl unload /Library/LaunchDaemons/org.jenkins-ci.plist</div></pre></td></tr></table></figure>
<p>然后通过命令行或者直接修改<code>/Library/LaunchDaemons/org.jenkins-ci.plist</code>文件</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins20.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 然后添加权限</div><div class="line">$ sudo chown -R userName /Users/Shared/Jenkins</div><div class="line">$ sudo chown -R userName /var/log/jenkins</div><div class="line"></div><div class="line">#重启Jenkins</div><div class="line">$ sudo launchctl load /Library/LaunchDaemons/org.jenkins-ci.plist</div></pre></td></tr></table></figure>
<h5 id="3-2-编写jenkins设置"><a href="#3-2-编写jenkins设置" class="headerlink" title="3.2 编写jenkins设置"></a>3.2 编写jenkins设置</h5><p>之前的设置跟<a href="http://pirrla.cn/2017/12/18/jenkins/jenkins1/" target="_blank" rel="external">第一篇</a>设置一样，设定好每分钟自动从代码库获取更新</p>
<p>然后到了构建操作脚本</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins17.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">id</div><div class="line">set +e</div><div class="line">echo &apos;&gt;&gt;&gt; Get old container id&apos;</div><div class="line"></div><div class="line"># 查找正在运行的docker容器</div><div class="line">CID=$(/usr/local/bin/docker ps | grep &quot;my_nodejs&quot; | awk &apos;&#123;print $1&#125;&apos;)</div><div class="line"># 获取使用“my_nodejs”镜像的容器id</div><div class="line">echo $CID</div><div class="line"></div><div class="line"># 根据新的代码，构建新的docker</div><div class="line">/usr/local/bin/docker build -t my_nodejs .</div><div class="line"></div><div class="line"># 停止旧的容器</div><div class="line">if [ &quot;$CID&quot; != &quot;&quot; ];then</div><div class="line">  /usr/local/bin/docker stop $CID</div><div class="line">  # 删除旧容器</div><div class="line">/usr/local/bin/docker rm $CID</div><div class="line">fi</div><div class="line"></div><div class="line"># 启动新容器</div><div class="line">/usr/local/bin/docker run -p 8000:8000 -d my_nodejs</div><div class="line"></div><div class="line"></div><div class="line"># 删除旧镜像</div></pre></td></tr></table></figure>
<p>这样就完成了一个自动化部署docker的操作。</p>
<p>注意，这里只删除了容器，但是每一次构建都会产生新的镜像，旧镜像还在，但是名字变为了none，所以我们还需要定期删除镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 删除旧镜像</div><div class="line">docker images|grep none|awk &apos;&#123;print $3 &#125;&apos;|xargs docker rmi</div></pre></td></tr></table></figure>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins15.png" alt=""></p>
<p>References:</p>
<p>[1] <a href="http://www.cnblogs.com/Leo_wl/p/4314792.html" target="_blank" rel="external">使用Jenkins来构建Docker容器</a></p>
<p>[2] <a href="http://www.runoob.com/docker/docker-tutorial.html" target="_blank" rel="external">Docker 教程</a></p>
<p>[3] <a href="http://blog.huangang.net/2017/01/06/docker%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%90%8E%E6%B7%BB%E5%8A%A0%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84/" target="_blank" rel="external">Docker启动后的端口映射</a></p>
<p>[4] <a href="http://blog.csdn.net/woshiluahuo/article/details/52239407" target="_blank" rel="external">进入docker容器的方法</a></p>
<p>[5] <a href="http://blog.csdn.net/u010397369/article/details/41045251" target="_blank" rel="external">如何进入Docker容器</a></p>
<p>[6] <a href="https://blog.catscarlet.com/201612022593.html" target="_blank" rel="external">https://blog.catscarlet.com/201612022593.html</a></p>
<p>[7] <a href="http://ju.outofmemory.cn/entry/306621" target="_blank" rel="external">http://ju.outofmemory.cn/entry/306621</a></p>
<p>[8] <a href="https://www.qcloud.com/community/article/164816001481011806" target="_blank" rel="external">https://www.qcloud.com/community/article/164816001481011806</a></p>
<p>[9] <a href="https://www.jianshu.com/p/41f2def6ec59" target="_blank" rel="external">https://www.jianshu.com/p/41f2def6ec59</a></p>
<p>[10] <a href="http://www.cnblogs.com/ihojin/p/jenkins-permission.html" target="_blank" rel="external">Mac Jenkins 权限问题</a></p>
<p>[11] <a href="https://blog.catscarlet.com/201612022593.html" target="_blank" rel="external">https://blog.catscarlet.com/201612022593.html</a></p>
<p>[12] <a href="http://www.runoob.com/docker/docker-command-manual.html" target="_blank" rel="external">Docker 命令大全</a></p>
<p>[13] <a href="http://blog.51cto.com/tangoo/1435078" target="_blank" rel="external">Mac Jenkins 修改端口</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/20/jenkins/jenkins3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/20/jenkins/jenkins3/" itemprop="url">
                  Jenkins学习笔记3-重启Node.js服务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-20T00:00:00+08:00">
                2017-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们在之前的文章已经完成了当github上python代码有新的push操作之后，jenkins会自动pull最新的代码，并进行编译执行。因为python代码不能体现服务的持续展现，所以我们现在选择一个网页网站的node.js页面进行尝试。</p>
<h3 id="1-项目代码简介"><a href="#1-项目代码简介" class="headerlink" title="1.项目代码简介"></a>1.项目代码简介</h3><p>简单的网页面显示，没有具体的数据存储操作</p>
<h3 id="2-代码Jenkins部署"><a href="#2-代码Jenkins部署" class="headerlink" title="2.代码Jenkins部署"></a>2.代码Jenkins部署</h3><h5 id="2-1-安装node-js插件"><a href="#2-1-安装node-js插件" class="headerlink" title="2.1 安装node.js插件"></a>2.1 安装node.js插件</h5><p>到jenkins插件管理界面下载<a href="https://wiki.jenkins.io/display/JENKINS/NodeJS+Plugin" target="_blank" rel="external">Node.js插件</a></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins12.png" alt=""></p>
<p>安装完，对jenkins进行重启</p>
<h5 id="2-2-插件配置"><a href="#2-2-插件配置" class="headerlink" title="2.2 插件配置"></a>2.2 插件配置</h5><p>进入<strong>Jenkins - Manage Jenkins - Global Tool Configuration</strong>设置页面</p>
<p>找到NodeJS设置，点击<strong>NodeJS installations…</strong></p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins13.png" alt=""></p>
<p>帮这个node.js环境填上一个名字，然后选择需要安装的版本号。</p>
<p>保存，即可。</p>
<h5 id="2-3-NPM-install"><a href="#2-3-NPM-install" class="headerlink" title="2.3 NPM install"></a>2.3 NPM install</h5><p>现在选择Build Now，不管有没有job，系统会先安装node.js环境在workspace里。</p>
<p>然后去到job的配置页面，在build里加入<strong>Execute NodeJS script</strong>操作</p>
<p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins14.png" alt=""></p>
<font color="red">这里如果把语句放入Node.js脚本执行框，会提示错误。（很奇怪，待研究）</font>

<p>所以我们将语句按顺序，放在script下面的shell脚本里，node.js脚本为空。</p>
<p>执行<code>npm install</code>对从远程仓库下载下来的代码进行构建，安装第三方库。</p>
<h5 id="2-4-PM2守护进程"><a href="#2-4-PM2守护进程" class="headerlink" title="2.4 PM2守护进程"></a>2.4 PM2守护进程</h5><ul>
<li><p>尝试一</p>
<p>直接在shell脚本中执行<code>node index.js</code>操作，node.js服务正常启动，可以正常访问网页，但是在jenkins中，该job是一直处于执行的阶段，如果有新的代码推送上代码仓库，虽然jenkins可以获取到新的代码，但是因为旧的job一直执行，造成阻塞，只能人工进行停止服务，不能实现代码构建部署自动化</p>
</li>
<li><p>尝试二</p>
<p>因为直接启动node.js不行，所以我们考虑使用nohup进行后台执行，使用脚本<code>nohup node index.js &amp;</code>，虽然显示无错误，该job也正常执行完成，但是无法访问网站，查看进程发现不存在node.js进程</p>
</li>
<li><p>尝试三</p>
<p>因为nohup不能持久地运行node.js服务，所以我们选了一个进程守护程序来守护进程，我们选择的是<a href="https://github.com/Unitech/pm2" target="_blank" rel="external">pm2</a>，先在shell脚本中加入代码<code>npm install pm2 -g</code>，然后再启动进程<code>pm2 start index.js</code>，经过测试node.js进程成功常驻后台，网页访问正常，jenkins正常完成job的构建。</p>
<p>由于我们希望达到自动化代码构建部署的效果，所以jenkins的shell脚本更改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pm2 stop index.js</div><div class="line">pm2 start index.js</div></pre></td></tr></table></figure>
<p>这样当代码有更新的时候，先对原先的node.js进行停止，然后重新开启新的node.js服务。</p>
</li>
</ul>
<p>至此，完成node.js代码的自动化构建部署。</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><p>对于网页项目，还有许多的流程持续发布，都需要经过浏览器测试的环节。</p>
<h5 id="1-可以部署多个浏览器环境进行测试："><a href="#1-可以部署多个浏览器环境进行测试：" class="headerlink" title="1.可以部署多个浏览器环境进行测试："></a>1.可以部署多个浏览器环境进行测试：</h5><p><img src="http://ondsf10qe.bkt.clouddn.com/jenkins11.png" alt=""></p>
<p>在网站的上线之前，可以部署一些浏览器测试环境，例如Firefox,IE,Safari等等的不同环境，当全部环境通过测试之后，才发布，提高了产品的容错性。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.pirrla.cn/2017/12/19/jenkins/jenkins2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alan Wong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ondsf10qe.bkt.clouddn.com/avatar01.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note down something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/19/jenkins/jenkins2/" itemprop="url">
                  Jenkins学习笔记2-Sonar实现代码质量分析（提交到代码仓库后）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-19T00:00:00+08:00">
                2017-12-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jenkins/" itemprop="url" rel="index">
                    <span itemprop="name">jenkins</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-代码质量管理"><a href="#1-代码质量管理" class="headerlink" title="1.代码质量管理"></a>1.代码质量管理</h3><p>此次代码质量管理的需求，是在用户将本地的代码提交到远程仓库后，进行代码质量分析。</p>
<p>此处的代码质量不单单指有无拼写错误、格式错误等，还包括代码重复率、鲁棒性、注释率等等的指标。所以单纯的syntax错误已经不能满足我们的需求，我们希望团队能够写出高效的代码。</p>
<h3 id="2-SonarQube"><a href="#2-SonarQube" class="headerlink" title="2.SonarQube"></a>2.SonarQube</h3><p>Sonar是一个用于代码质量管理的开放平台，同样支持很多的插件，可以集成不同的测试工具，从而对多种语言(包括Java、C/C++，Javascript，C#等)的代码进行分析，并且以数据可视化的界面进行显示，提高了代码的审查率。</p>
<h5 id="2-1-SonarQube安装"><a href="#2-1-SonarQube安装" class="headerlink" title="2.1 SonarQube安装"></a>2.1 SonarQube安装</h5><p>可以到<a href="https://www.sonarqube.org/downloads/" target="_blank" rel="external">官网</a>下载最新的LTS包，Windows平台的话可以直接执行wrapper.exe文件，即可启动Sonar服务，unix平台的可以通过<code>./sonar.sh start</code>启动服务。</p>
<p><code>./sonar.sh stop</code>停止服务</p>
<p><code>./sonar.sh restart</code>重启服务</p>
<p>当出现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Starting SonarQube...</div><div class="line">Started SonarQube.</div></pre></td></tr></table></figure>
<p>则启动成功</p>
<p>默认的端口是9000，访问<code>localhost:9000</code>需要进行登录。</p>
<p>默认的用户名和密码都是<code>admin</code></p>
<h5 id="2-2-SonarQube-Scanner安装"><a href="#2-2-SonarQube-Scanner安装" class="headerlink" title="2.2 SonarQube Scanner安装"></a>2.2 SonarQube Scanner安装</h5><p>除了SonarQube服务外，我们还需要安装一个SonarQube Scanner作为分析源码的软件。</p>
<p><a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner" target="_blank" rel="external">下载地址</a>下载相应系统版本的scanner之后，进行解压缩，放置到适当的位置。</p>
<p>最好能将该文件夹的bin文件夹添加入环境变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#Macos下添加环境变量的方法</div><div class="line">#在命令行输入</div><div class="line">$ vi ~/.bash_profile</div><div class="line"></div><div class="line">#在文件的最后添加类似的路径</div><div class="line">export PATH=/usr/local/sonar-scanner-3.0.3.778-macosx/bin:$PATH</div><div class="line">#即完成了添加</div></pre></td></tr></table></figure>
<p>然后可以进入对配置文件<code>./conf/sonar-scanner.properties</code>进行设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#基础设置两个就可以了</div><div class="line">#----- Default SonarQube server 设置SonarQube的服务地址</div><div class="line">sonar.host.url=http://localhost:9000</div><div class="line"></div><div class="line">#----- Default source code encoding 设置默认的源码编码格式</div><div class="line">sonar.sourceEncoding=UTF-8</div></pre></td></tr></table></figure>
<p>然后当我们需要对一个项目进行代码分析时，需要在项目的根目录上创建一个<code>sonar*-project.properties</code>文件，对项目信息进行配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 为这个项目配置唯一的标识码（必填）</div><div class="line"># 例如以下的URL的id就是标识码</div><div class="line"># http://localhost:9000/dashboard?id=myproject</div><div class="line">sonar.projectKey=myproject</div><div class="line"># 这是在SonarQube上展示的名字和版本号(重要选填)</div><div class="line">sonar.projectName=My project</div><div class="line">sonar.projectVersion=1.0</div><div class="line"></div><div class="line"># 源码的地址(必填)，有多个路径用&apos;,&apos;符号隔开</div><div class="line"># 不同系统需要注意路径的&apos;/&apos;和&apos;\&apos;符号</div><div class="line">sonar.sources=.</div><div class="line"> </div><div class="line"># 编码，默认是系统编码(选填)</div><div class="line">#sonar.sourceEncoding=UTF-8</div></pre></td></tr></table></figure>
<p>然后直接命令行运行<code>sonar-scanner</code>即可，我们现在可以在SonarQube上看到代码质量分析报告了。</p>
<p>如果不是在当前目录运行代码分析，可以设定字段<code>sonar.projectBaseDir=</code>来制定代码的位置。</p>
<p>当然如果不希望重新为每一个项目创造一个配置文件，或者无法再根目录创建文件，还有两种替代性的方法可以配置：</p>
<ul>
<li>可以在命令行启动sonar-scanner的时候添加上配置，例如</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># -D&lt;arg&gt;定义配置</div><div class="line">sonar-scanner -Dsonar.projectKey=myproject -Dsonar.sources=src1</div></pre></td></tr></table></figure>
<ul>
<li>可以在另外的位置创建配置文件，然后启动sonar-scanner的时候设置路径</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sonar-scanner -Dproject.settings=../myproject.properties</div></pre></td></tr></table></figure>
<h5 id="2-3-MySQL配置"><a href="#2-3-MySQL配置" class="headerlink" title="2.3 MySQL配置"></a>2.3 MySQL配置</h5><p>sonar内部是有配置数据库的，但是效率低不能应用于生产环境，所以我们需要配置自己的数据库，用户保存sonar的分析报告和配置等。</p>
<p>这里选择的是MySQL的分支MariaDB，因为MySQL有两种引擎，MyISAM和InnoDB，而MyISAM是比较老旧的引擎了，所以sonar不支持MyISAM，所以我们选择使用MariaDB。</p>
<p>配置文件在<code>sonarqube-6.7/conf/sonar.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sonar.jdbc.username=sonar            #数据库用户</div><div class="line">sonar.jdbc.password=sonar@pw     #数据库密码</div><div class="line"></div><div class="line">sonar.jdbc.url=jdbc:mysql://localhost:3306/sonar?useUnicode=true&amp;character    Encoding=utf8&amp;rewriteBatchedStatements=true&amp;useConfigs=maxPerformance</div></pre></td></tr></table></figure>
<p>只需要把数据库的用户名和密码填上，然后解除SQL的注释就可以了。</p>
<p>可能还需要将数据库驱动放入<code>sonarqube-6.7/extensions/jdbc-driver/mysql</code>中</p>
<h5 id="2-3-SonarQube-简介"><a href="#2-3-SonarQube-简介" class="headerlink" title="2.3 SonarQube 简介"></a>2.3 SonarQube 简介</h5><blockquote>
<p>SonarQube是一个用于代码质量管理的开源平台（Java开发），用于管理源代码的质量，可以从七个维度检测代码质量,通过插件形式，可以支持包括Java，C#，C/C++，PHP，PL/SQL，Cobol，Web，XML，JavaScrip，Groovy等等二十几种编程语言的代码质量管理与检测。</p>
</blockquote>
<p>参考资料：</p>
<p>[1] <a href="https://docs.sonarqube.org/display/PLUG/GitHub+Plugin" target="_blank" rel="external">Github Plugin for Sonar</a></p>
<p>[2] <a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner" target="_blank" rel="external">SonarQube Scanner</a></p>
<p>[3] <a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+Jenkins" target="_blank" rel="external">Analyzing with SonarQube Scanner for Jenkins</a></p>
<p>[4] <a href="https://docs.sonarqube.org/display/SONAR/Analysis+Parameters" target="_blank" rel="external">Analysis Parameters</a></p>
<p>[5] <a href="https://stackoverflow.com/questions/32047585/jenkins-sonar-github-integration" target="_blank" rel="external">https://stackoverflow.com/questions/32047585/jenkins-sonar-github-integration</a></p>
<p>[6] <a href="https://github.com/10up/wp-local-docker/issues/6" target="_blank" rel="external">Docker启动SonarQube错误es137</a></p>
<p>[7] <a href="https://yq.aliyun.com/articles/316487" target="_blank" rel="external">https://yq.aliyun.com/articles/316487</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ondsf10qe.bkt.clouddn.com/avatar01.png"
               alt="Alan Wong" />
          <p class="site-author-name" itemprop="name">Alan Wong</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/alanhuangym" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alan Wong</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
